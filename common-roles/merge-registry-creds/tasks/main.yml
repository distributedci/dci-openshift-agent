---
- name: "Check if the list has items"
  assert:
    that:
      - "{{ mrc_auth_files is defined }}"
      - "{{ mrc_auth_files | length > 0 }}"
    fail_msg: "A list of JSON auth files is required"

- name: "Process auth files"
  set_fact:
    mrc_data_list: "{{ mrc_data_list | default([]) +
                    [lookup('file', file) | from_json] }}"
  no_log: true
  loop: "{{ mrc_auth_files }}"
  loop_control:
    loop_var: file
  when:
    - lookup('file', file) is defined

- name: "Combine auth files"
  set_fact:
    mrc_auth_data: "{{ mrc_auth_data | default({}) |
                   combine(file | default({}), recursive=True) }}"
  no_log: true
  loop: "{{ mrc_data_list }}"
  loop_control:
    loop_var: file
  when:
    - mrc_data_list is defined

- name: "Set the combined auth file"
  tempfile:
    state: file
    prefix: "auth_"
  register: mrc_auth_file

- name: "Write consolidated auth file"
  copy:
    content: "{{ mrc_auth_data | to_json }}"
    dest: "{{ mrc_auth_file.path }}"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0400"

- name: "Unset consolidated auth fact"
  set_fact:
    mrc_auth_file: "{{ mrc_auth_file.path }}"
...
