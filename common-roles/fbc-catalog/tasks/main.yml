---
- name: "Validate parameters"
  assert:
    that: ( fbc_bundles is defined ) and ( fbc_bundles | type_debug == "list" )
    fail_msg: "A list of operator bundles is required"

- name: "Validate parameters"
  assert:
    that: "{{ item }} is defined"
    fail_msg: "The parameter {{ item }} is required"
  with_items:
      - fbc_target_registry

- name: "Set opm cmd"
  set_fact:
    fbc_opm_cmd: "opm {{ fbc_opm_args }} "

- name: Generate catalog path
  set_fact:
    fbc_index_image: "{{ fbc_target_registry }}:{{ fbc_index_tag | default('latest') }}"

- name: Create temporary directory
  tempfile:
    state: directory
    prefix: fbc_tmp_dir.
  register: fbc_tmp_dir
  notify:
    - "Delete temp directory"

- name: "Set working directory"
  set_fact:
    fbc_tmp_dir: "{{ fbc_tmp_dir.path }}"

- name: "Download stable opm client"
  vars:
    ocp_clients_url: "https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/opm-linux.tar.gz"
  unarchive:
    src: "{{ ocp_clients_url }}"
    dest: "{{ fbc_tmp_dir }}"
    remote_src: true
    mode: 0755

- name: "Create index build directory"
  file:
    path: "{{ fbc_tmp_dir }}/catalog"
    state: directory
    mode: 0755

- name: "Build index image in temporary directory"
  include_tasks: add-bundle.yml
  loop: "{{ fbc_bundles }}"
  loop_control:
    loop_var: bundle
    label: "{{ bundle }}"

- name: "Validate catalog"
  shell: |
    ./opm validate catalog
  args:
    chdir: "{{ fbc_tmp_dir }}"
  register: catalog_validation
  retries: 6
  delay: 10
  until: catalog_validation.rc == 0

- name: "Add Dockerfile"
  copy:
    src: catalog.Dockerfile
    dest: "{{ fbc_tmp_dir }}/catalog.Dockerfile"
    mode: 644

- name: "Build operator catalog"
  shell: |
    podman build . \
    -f catalog.Dockerfile \
    -t {{ fbc_index_image }}
  args:
    chdir: "{{ fbc_tmp_dir }}"

- name: "fbc_index_image"
  debug:
    msg: "Catalog image build as {{ fbc_index_image }}"
...
