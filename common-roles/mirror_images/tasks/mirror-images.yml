- name: "Mirror image"
  vars:
    image_name: "{{ image | regex_replace('^[^/]*/', '') }}"
    local_image_location: "{{ mi_local_registry }}/{{ image_name }}"
  block:
    - name: "mirror_images : Mirror image {{ image_name }}"
      command:
        cmd: >
          skopeo copy
          --remove-signatures
          {% if mi_authfile is defined %}
          --authfile {{ mi_authfile }}
          {% endif %}
          {% if mi_src_authfile is defined %}
          --src-authfile {{ mi_src_authfile }}
          {% endif %}
          {% if mi_dest_authfile is defined %}
          --dest-authfile {{ mi_dest_authfile }}
          {% endif %}
          --dest-tls-verify=false
          docker://{{ image }}
          docker://{{ local_image_location }}
      register: mi_skopeo_copy
      retries: 5
      delay: 5
      until: mi_skopeo_copy is not failed

  rescue:
    - name: "mirror_images : {{ image_name }} already mirrored"
      command: >
        skopeo inspect
        {% if mi_authfile is defined %}
        --authfile {{ mi_authfile }}
        {% endif %}
        {% if dest_authfile is defined %}
        --authfile {{ mi_dest_authfile }}
        {% endif %}
        --tls-verify=false
        docker://{{ local_image_location }}
      register: mi_inspect
      failed_when: mi_inspect.rc != 0
