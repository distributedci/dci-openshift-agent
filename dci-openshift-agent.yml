---
# Step 0 : DCI setup
- name: 'Set dci variables'
  hosts: localhost
  vars:
    dci_status: 'new'
  tags:
    - job
  tasks:
    - name: Read credentials from env vars
      set_fact:
        dci_client_id="{{ lookup('env','DCI_CLIENT_ID') }}"
        dci_api_secret="{{ lookup('env','DCI_API_SECRET') }}"
        dci_cs_url="{{ lookup('env','DCI_CS_URL') }}"
      no_log: true

    # Schedule a new job only if not passed via pipeline
    - name: Schedule a new job
      dci_job:
        components: "{{ dci_components }}"
        components_by_query: "{{ dci_components_by_query }}"
        topic: "{{ dci_topic }}"
      register: job_info
      when: job_info is not defined

    - name: set job id
      set_fact:
        job_id: '{{ job_info.job.id }}'

    - name: Set DCI tags for the current job
      dci_job:
        id: '{{ job_id }}'
        tags: '{{ dci_tags }}'
      when: dci_tags

# Step 1 : pre run
- name: 'Launch pre-run'
  hosts: localhost
  tags:
    - pre-run
  vars:
    dci_status: 'pre-run'
  tasks:
    - block:
        # prepare infrastructure
        - name: Run the pre-run hook
          include_tasks: 'plays/pre-run.yml'

        - name: Run the pre-run hook
          include_tasks: '{{ item }}/hooks/pre-run.yml'
          loop: "{{ dci_config_dirs }}"

      rescue: &teardown_error
        - block:

            - block:
                - name: Run the teardown process
                  include_tasks: "{{ item }}/hooks/teardown.yml"
                  loop: "{{ dci_config_dirs }}"
                  when: dci_teardown_on_failure|bool
              ignore_unreachable: true
              ignore_errors: true

          always:
            - name: Run the error process
              include_tasks: plays/error.yml

          ignore_unreachable: true

# Step 2 : configure
- name: 'Launch configure'
  hosts: provisioner
  tags:
    - running
    - configure
  vars:
    dci_status: 'running'
  tasks:
    - block:
        # Prepare provisioner host
        - name: Configure provisioner
          include_tasks: plays/configure-provisioner.yml

        - name: Launch configure
          include_tasks: '{{ item }}/hooks/configure.yml'
          loop: "{{ dci_config_dirs }}"

      rescue: *teardown_error

# Step 3a : installing
- name: 'Launch install'
  hosts: provisioner
  tags:
    - running
    - installing
  vars:
    dci_status: 'running'
  tasks:
    - block:
        - name: "dci-openshift-agent : Launch install"
          include_tasks: plays/install.yml

        - name: "dci-openshift-agent : Launch partner install"
          include_tasks: '{{ item }}/hooks/install.yml'
          loop: "{{ dci_config_dirs }}"

      when:
        - dci_main is not defined or dci_main == 'install'

      rescue: &teardown_failure
        - block:

            - block:
                - name: Run the teardown process
                  include_tasks: "{{ item }}/hooks/teardown.yml"
                  loop: "{{ dci_config_dirs }}"
                  when: dci_teardown_on_failure|bool
              ignore_unreachable: true
              ignore_errors: true

          always:
            - name: Run the failure process
              include_tasks: plays/failure.yml

          ignore_unreachable: true

# Step 3b : upgrading
- name: 'Launch upgrade'
  hosts: provisioner
  tags:
    - running
    - upgrading
  vars:
    dci_status: 'running'
  tasks:
    - block:
        - name: "dci-openshift-agent : Launch upgrade"
          vars:
            local_registry: "{{ hostvars[groups['registry_host'][0]].local_registry }}"
            local_repo: "{{ hostvars[groups['registry_host'][0]].local_repo }}"
          include_tasks: plays/upgrade.yml

        - name: "dci-openshift-agent : Launch partner upgrade"
          vars:
            local_registry: "{{ hostvars[groups['registry_host'][0]].local_registry }}"
            local_repo: "{{ hostvars[groups['registry_host'][0]].local_repo }}"
          include_tasks: '{{ item }}/hooks/upgrade.yml'
          loop: "{{ dci_config_dirs }}"

      when:
        - dci_main is defined
        - dci_main == 'upgrade'

      rescue: *teardown_failure

# Step 4 : redhat testing
- name: 'Launch Red Hat tests'
  hosts: localhost
  tags:
    - running
    - testing
    - redhat-testing
  vars:
    dci_status: 'running'
  tasks:
    - block:
        - include_tasks: plays/tests.yml

      rescue: *teardown_failure

# Step 5 : partner testing
- name: 'Launch partner tests'
  hosts: localhost
  tags:
    - running
    - testing
    - partner-testing
  vars:
    dci_status: 'running'
  tasks:
    - block:
        # Launch user tests
        - name: Run the partner tests
          include_tasks: '{{ item }}/hooks/tests.yml'
          loop: "{{ dci_config_dirs }}"

      rescue: *teardown_failure

# Step 6 : post run
- name: Launch post run
  hosts: localhost
  tags:
    - post-run
  vars:
    dci_status: 'post-run'
  tasks:
    - block:
        - include_tasks: plays/post-run.yml

        - name: Run the partner post-run
          include_tasks: '{{ item }}/hooks/post-run.yml'
          loop: "{{ dci_config_dirs }}"

      rescue: *teardown_error

# Step 7 : state "success"
- name: 'Success'
  hosts: localhost
  tags:
    - success
  vars:
    dci_status: 'success'
  tasks:
    - block:
        - name: Run the success hook
          include_tasks: '{{ item }}/hooks/success.yml'
          loop: "{{ dci_config_dirs }}"

        - name: Run the teardown process
          include_tasks: "{{ item }}/hooks/teardown.yml"
          loop: "{{ dci_config_dirs }}"
          when: dci_teardown_on_failure|bool
      ignore_unreachable: true
      ignore_errors: true
