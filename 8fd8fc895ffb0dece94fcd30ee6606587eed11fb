{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "b63a9212_82ed730a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 789
      },
      "writtenOn": "2023-06-08T12:42:02Z",
      "side": 1,
      "message": "For reference, this is the job that triggered the need for this change:\n\nhttps://www.distributed-ci.io/jobs/95f61228-9f7f-40a9-a8e7-0b6d5f79d630/jobStates?sort\u003ddate",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "260be30f_c2732215",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 908
      },
      "writtenOn": "2023-06-08T19:07:31Z",
      "side": 1,
      "message": "Nacho, I wonder if a multinode cluster deployment creates /opt/cache and stores the pull-secret.txt so that SNO deployments take advantage of it.\n\nFrom the sno plays, I see that SNO installer role is expecting that var pullsecret_file points to \"{{ cache_dir }}/pull-secret.txt\"[1] in the ansible controller node, and it relies in the pre-run.yml to place it there, but only if var pullsecret_file is defined[2]. \nIn the job you mentioned, I see that at the end the pre-run.yml play stores the content of the pull-secret in a diff path[3] ($HOME/clusterconfigs-{{ cluster }}-sno/pull-secret.txt), that\u0027s why I believe the ocp_on_libvirt deployment placed the file there in other clusters/jobs, otherwise all our SNO jobs will fail. \n\nAnyways, I think it\u0027s safe to copy it, but do you mind adding a check first, only copy the file if it does not exists in the remote.\n\n[1] https://github.com/redhat-cip/dci-openshift-agent/blob/master/roles/sno-installer/vars/main.yml#L4\n[2] https://github.com/redhat-cip/dci-openshift-agent/blob/master/plays/pre-run.yml#L57-L77\n[3] https://www.distributed-ci.io/jobs/95f61228-9f7f-40a9-a8e7-0b6d5f79d630/jobStates?sort\u003ddate\u0026task\u003da6690db6-cebb-4ca7-b590-45e6c3d8fc41",
      "parentUuid": "b63a9212_82ed730a",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "df7c5b77_6742562e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 724
      },
      "writtenOn": "2023-06-08T19:10:04Z",
      "side": 1,
      "message": "For the record, I recall we we having issues with pullsecret in the bos2server/opt/cache, so we manually copied them. Yeah, this need to be automated.",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d57d2629_68797cae",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 789
      },
      "writtenOn": "2023-06-09T08:08:20Z",
      "side": 1,
      "message": "Hi Manny, thanks for your notes.\n\nI don\u0027t believe the SNO deployment relies on a previous IPI deployment to have the pull secret file placed in the cache dir. At least, not in my experience, since I started testing the BOS2 server09 IPI and then moved to SNO and the file was still missing.\n\nI\u0027m guessing Beto has the right answer here.\n\nRegarding the check task, what would be the benefit of it? I mean, after all, the Ansible copy module already checks if the file is present and it only copies it if the file does not exist or it\u0027s to be tested. [1] [2] [3]\n\n[1] https://github.com/ansible/ansible/blob/6ac0ea35672eed7778f530b5cc7751d41b09c43a/lib/ansible/modules/copy.py#L663\n\n[2] https://github.com/ansible/ansible/blob/6ac0ea35672eed7778f530b5cc7751d41b09c43a/lib/ansible/modules/copy.py#L694\n\n[3] https://github.com/ansible/ansible/blob/6ac0ea35672eed7778f530b5cc7751d41b09c43a/lib/ansible/modules/copy.py#L712",
      "parentUuid": "260be30f_c2732215",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fccc7c71_92f99634",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 908
      },
      "writtenOn": "2023-06-09T13:35:22Z",
      "side": 1,
      "message": "Ouch, if we had to copy manually before, that explains it :/\nCool, I didn\u0027t know the copy will do all that, then that\u0027s fine",
      "parentUuid": "d57d2629_68797cae",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e92d0492_a92010b8",
        "filename": "roles/sno-node-prep/tasks/95_check_pull_secret.yml",
        "patchSetId": 2
      },
      "lineNbr": 3,
      "author": {
        "id": 908
      },
      "writtenOn": "2023-06-09T13:35:22Z",
      "side": 1,
      "message": "My only concern now, is that if you look for dci* vars in sno roles you won\u0027t find any, because the roles were crafted so anybody could use them without the need of DCI, so this will break that approach, since \"dci_pullsecret_file\" is not defined in the sno roles, but during the execution of the pre-run.\n\nI suggest to use this:\n\u003e       copy:\n\u003e         content: \"{{ hostvars[\u0027localhost\u0027][\u0027pullsecret\u0027] }}\"\n\nBecause, at least SNO is expecting pullsecret var[1] and we set that variable for connected envs in the pre-run[2] wdyt? Or if you think there are better ways please let me know.\n\n[1] https://github.com/redhat-cip/dci-openshift-agent/blob/master/roles/sno-node-prep/tasks/10_validation.yml#L44-L58\n[2] https://github.com/redhat-cip/dci-openshift-agent/blob/master/plays/pre-run.yml#L23-L28",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8d48046b_c245c691",
        "filename": "roles/sno-node-prep/tasks/95_check_pull_secret.yml",
        "patchSetId": 2
      },
      "lineNbr": 3,
      "author": {
        "id": 724
      },
      "writtenOn": "2023-06-09T19:19:43Z",
      "side": 1,
      "message": "What about something like:\n\n- name: \"installer : SNO Node preparation\"\n  vars:\n    sno_pullsecret: \"{{ dci_pullsecret_file }}\"\n  import_role:\n    name: sno-node-prep\n \nRename the default pullsecret var in the role to sno_pullsecret and replace the required instances.\n\nAt some time we may need to start qualifying the sno role variables.",
      "parentUuid": "e92d0492_a92010b8",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f11fecde_fafbfd98",
        "filename": "roles/sno-node-prep/tasks/95_check_pull_secret.yml",
        "patchSetId": 2
      },
      "lineNbr": 3,
      "author": {
        "id": 908
      },
      "writtenOn": "2023-06-09T21:24:47Z",
      "side": 1,
      "message": "That sounds good, it passes the dci* var to the sno role, so the role remains standalone.",
      "parentUuid": "8d48046b_c245c691",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a01d800f_46dce4b2",
        "filename": "roles/sno-node-prep/tasks/95_check_pull_secret.yml",
        "patchSetId": 2
      },
      "lineNbr": 3,
      "author": {
        "id": 789
      },
      "writtenOn": "2023-06-12T07:48:45Z",
      "side": 1,
      "message": "Sounds good to me. I didn\u0027t know about the \"DCI independence\".\n\nLet me implement the changes as Beto suggests.",
      "parentUuid": "f11fecde_fafbfd98",
      "revId": "8fd8fc895ffb0dece94fcd30ee6606587eed11fb",
      "serverId": "6c1dc8ef-8b94-40e4-bd83-c2359d45ecc0"
    }
  ]
}