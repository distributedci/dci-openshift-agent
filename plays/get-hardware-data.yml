---

- name: "Set disconnected mode variable"
  ansible.builtin.set_fact:
    dci_disconnected: "{{ dci_disconnected | default(false) }}"

- name: Get list of nodes from cluster
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes_info
  ignore_errors: true

- name: Get kernel information for all nodes
  vars:
    node_name: "{{ item.metadata.name }}"
  ansible.builtin.shell:
    cmd: >
      {{ oc_tool_path }} debug node/{{ node_name }}
      -- chroot /host sh -c 'echo "{\"node\": \"{{ node_name }}\", \"version\": \"$(uname -r)\", \"params\": \"$(cat /proc/cmdline)\"}"'
  register: kernel_info
  ignore_errors: true
  loop: "{{ nodes_info.resources | default([]) }}"
  when:
    - nodes_info.resources is defined
    - item.status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0

- name: Save kernel information to files
  ansible.builtin.copy:
    content: >-
      {{ { 'kernel': {
        'node': (item.stdout | from_json).node,
        'version': (item.stdout | from_json).version,
        'params': (((item.stdout | from_json).params | default('') | cmdline_to_json | from_json))
      } } | to_json }}
    dest: "{{ job_logs.path }}/dci-extra.kernel.{{ item.item.metadata.name }}.json"
    mode: '0644'
  ignore_errors: true
  loop: "{{ kernel_info.results | default([]) }}"
  when:
    - item is defined
    - item.rc is defined
    - item.rc == 0
    - item.stdout is defined
    - (item.stdout | length) > 0

- name: "Build lshw container for disconnected mode"
  when: dci_disconnected | default(false)
  block:
    - name: "Create temporary build directory for container"
      ansible.builtin.tempfile:
        state: directory
        suffix: lshw-build
      register: build_dir

    - name: "Copy Containerfile to build directory"
      ansible.builtin.copy:
        src: "files/Containerfile"
        dest: "{{ build_dir.path }}/Containerfile"
        mode: '0644'
      delegate_to: localhost

    - name: "Build lshw container"
      ansible.builtin.shell:
        cmd: >
          podman build
          {% if dci_pullsecret_file is defined %} --authfile {{ dci_pullsecret_file }} {% endif %}
          -t dci-lshw-container:latest
          {{ build_dir.path }}
      register: container_build_result
      ignore_errors: true

    - name: "Check if container build succeeded"
      ansible.builtin.fail:
        msg: "Failed to build lshw container. Build output: {{ container_build_result.stderr }}"
      when: container_build_result.rc != 0

    - name: Push container image to local registry
      ansible.builtin.shell:
        cmd: >
          podman push
          {% if dci_pullsecret_file is defined %} --authfile {{ dci_pullsecret_file }} {% endif %}
          dci-lshw-container:latest
          {{ dci_local_registry }}/dci-lshw-container:latest
      register: container_push_result
      ignore_errors: true

    - name: "Clean up build directory"
      ansible.builtin.file:
        path: "{{ build_dir.path }}"
        state: absent

    - name: "Run lshw using local container"
      vars:
        node_name: "{{ item.metadata.name }}"
      ansible.builtin.shell:
        cmd: >
          {{ oc_tool_path }} debug node/{{ node_name }}
          --image=dci-lshw-container:latest
          -- /usr/sbin/lshw -json -sanitize -numeric
      register: hardware_info
      ignore_errors: true
      loop: "{{ nodes_info.resources | default([]) }}"
      when:
        - dci_disconnected | default(false)
        - nodes_info.resources is defined
        - item.status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
        - container_push_result.rc == 0

- name: "Run lshw using UBI10 container (connected mode)"
  vars:
    node_name: "{{ item.metadata.name }}"
  ansible.builtin.shell:
    cmd: >
      {{ oc_tool_path }} debug node/{{ node_name }}
      --image="{% if dci_local_registry is defined and dci_local_registry != '' %}{{ dci_local_registry }}{% else %}registry.access.redhat.com{% endif %}/ubi10/ubi:latest"
      -- sh -c 'dnf install -y lshw > /dev/null && lshw -json -sanitize -numeric'
  register: hardware_info
  ignore_errors: true
  loop: "{{ nodes_info.resources | default([]) }}"
  when:
    - not (dci_disconnected | default(false))
    - nodes_info.resources is defined
    - item.status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0

- name: "Save hardware information to files"
  ansible.builtin.copy:
    content: >-
      {{ { 'hardware': {
        'node': item.item.metadata.name,
        'data': (item.stdout | from_json | dot_to_underscore) if (item.stdout is defined and item.rc == 0) else (null | default({})),
        'error': item.stderr if item.rc != 0 else (null | default(''))
      } } | to_json }}
    dest: "{{ job_logs.path }}/dci-extra.hardware.{{ item.item.metadata.name }}.json"
    mode: '0644'
  ignore_errors: true
  loop: "{{ hardware_info.results | default([]) }}"
  when:
    - hardware_info.results is defined
    - item is defined

...
