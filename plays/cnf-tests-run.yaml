---
- block:
  - name: Get date
    shell: date +%Y%m%d-%H%M%S
    register: date

  - name: set cnf_tests_image_registry for disconnected env
    set_fact:
       cnf_tests_image_registry: '{{ local_registry_host }}:{{ local_registry_port }}'
    when: dci_openshift_agent_cnf_tests_mode == "disconnected"

  - name: set cnf_tests_image_registry for non-disconnected env
    set_fact:
       cnf_tests_image_registry: 'quay.io/openshift-kni'
    when: dci_openshift_agent_cnf_tests_mode == "non-disconnected"

  - name: Run SCTP tests
    shell:
      cmd: >
       podman run -v {{ dci_cluster_config_dir }}/:/kubeconfig:Z  -e  KUBECONFIG=/kubeconfig/kubeconfig
       -v {{ dci_cluster_config_dir }}:/tests:Z {{ cnf_tests_image_registry }}/cnf-tests:{{ cnf_tests_version }}
       /usr/bin/test-run.sh  -ginkgo.focus="sctp" --junit /tests/{{ date.stdout }}/sctp
    ignore_errors: yes

  - name: Run PTP tests
    shell:
      cmd: >
       podman run -v {{ dci_cluster_config_dir }}/:/kubeconfig:Z  -e  KUBECONFIG=/kubeconfig/kubeconfig
       -v {{ dci_cluster_config_dir }}:/tests:Z {{ cnf_tests_image_registry }}/cnf-tests:{{ cnf_tests_version }}
       /usr/bin/test-run.sh  -ginkgo.focus="ptp" --junit  /tests/{{ date.stdout }}/ptp
    ignore_errors: yes

  - name: Run performance tests
    shell:
      cmd: >
       podman run -v {{ dci_cluster_config_dir }}/:/kubeconfig:Z  -e  KUBECONFIG=/kubeconfig/kubeconfig
       -v {{ dci_cluster_config_dir }}:/tests:Z {{ cnf_tests_image_registry }}/cnf-tests:{{ cnf_tests_version }}
       /usr/bin/test-run.sh  -ginkgo.focus="performance" --junit  /tests/{{ date.stdout }}/performance
    ignore_errors: yes

  - name: Run SRIOV tests
    shell:
      cmd: >
         podman run -v {{ dci_cluster_config_dir }}/:/kubeconfig:Z  -e  KUBECONFIG=/kubeconfig/kubeconfig
         -v {{ dci_cluster_config_dir }}:/tests:Z {{ cnf_tests_image_registry }}/cnf-tests:{{ cnf_tests_version }}
         /usr/bin/test-run.sh  -ginkgo.focus="sriov" --junit  /tests/{{ date.stdout }}/sriov
    ignore_errors: yes

  - name: Run DPDK tests
    shell:
      cmd: >
        podman run -v {{ dci_cluster_config_dir }}/:/kubeconfig:Z  -e  KUBECONFIG=/kubeconfig/kubeconfig
        -v {{ dci_cluster_config_dir }}:/tests:Z {{ cnf_tests_image_registry }}/cnf-tests:{{ cnf_tests_version }}
        /usr/bin/test-run.sh  -ginkgo.focus="dpdk" --junit  /tests/{{ date.stdout }}/dpdk
    ignore_errors: yes

  - name: Tar up the log directory
    archive:
      path: "{{ dci_cluster_config_dir }}/{{ date.stdout }}"
      dest: "{{ dci_cluster_config_dir }}/{{ date.stdout }}.tar"
      format: tar

  - name: Find test logs
    find:
      paths: "{{ dci_cluster_config_dir }}"
      recurse: yes
      patterns: "*.tar"
    register: logs_matched

  - name: Upload logs directory to DCI Control Server
    environment:
      - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
      - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
      - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
    dci_file:
      path: "{{ item.path }}"
      name: "{{ item.path | basename }}"
      job_id: "{{ hostvars.localhost.job_id }}"
    with_items: "{{ logs_matched.files }}"
  when:
    - (dci_openshift_agent_cnf_tests_mode is defined)
    - (dci_openshift_agent_cnf_tests_mode == "non-disconnected" or dci_openshift_agent_cnf_tests_mode == "disconnected")

