---
- name: "Enable gateway mode for 4.7 -> 4.8 upgrade"
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: gateway-mode-config
        namespace: openshift-network-operator
      data:
        mode: "local"
      immutable: true
  when:
    - enable_gateway_mode | default(false) | bool

- name: "Deactivate the upgrade of worker nodes - EUS"
  community.kubernetes.k8s:
    definition:
      kind: MachineConfigPool
      metadata:
        name: worker
      spec:
        paused: true
  when:
    - upgrade_eus | default(false) | bool

- name: "Upgrader: Running the Intermediate upgrade - EUS"
  vars:
    target_version: "{{ version_inter }}"
    version_pull_url: "{{ image_inter }}"
  include_tasks: upgrade-process.yml
  when:
    - upgrade_eus | default(false) | bool

- name: "Upgrader: Running the upgrade"
  vars:
    target_version: "{{ version }}"
  include_tasks: upgrade-process.yml

- name: "Reactivate the upgrade of worker nodes - EUS"
  community.kubernetes.k8s:
    definition:
      kind: MachineConfigPool
      metadata:
        name: worker
      spec:
        paused: false
  when:
    - upgrade_eus | default(false) | bool

- name: "Get worker nodes count - EUS"
  community.kubernetes.k8s_info:
    kind: Node
    label_selectors:
      - "node-role.kubernetes.io/worker"
  register: compute_nodes
  when:
    - upgrade_eus | default(false) | bool

- name: "Wait for Worker's MCPs reconciliation - EUS "
  vars:
    compute_nodes_count: "{{ compute_nodes.resources | default([]) | length  }}"
  when:
    - upgrade_eus | default(false) | bool
  block:
    - name: "Wait for Worker's MCPs reconciliation"
      include_role:
        name: redhatci.ocp.check_resource
      vars:
        resource_to_check: "MachineConfigPool"
        check_wait_retries: "{{ 16 * compute_nodes_count | int + 1  }}"
        check_wait_delay: 90
        check_reason: "EUS workers upgrade"

- name: "Upgrader : Pre-upgrade operators tasks"
  include_tasks: pre-upgrade.yml

- name: "Prepare operators and catalogs"
  include_tasks: prepare-operators.yml

- name: "Upgrader : Start the upgrade on installed operators"
  include_tasks: upgrade-operators.yml
  when:
    - upgrade_operators | default(true) | bool

- name: "Run cluster health checks"
  include_tasks: check-cluster-health.yml
...
