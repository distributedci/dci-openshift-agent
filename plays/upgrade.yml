---
- name: "upgrader : Get current version"
  community.kubernetes.k8s_info:
    api: config.openshift.io/v1
    kind: ClusterVersion
    name: version
  register: clusterVersion

- name: "upgrader : Get version and build from localhost vars"
  set_fact:
    version: "{{ hostvars.localhost.version_name }}"
    build: "{{ hostvars.localhost.build }}"

- name: "upgrader : Print versions"
  vars:
    - status_query: "conditions[?type=='Available'].message"
  debug:
    msg: "current={{ clusterVersion.resources[0].status | json_query(status_query) }} target={{ version }}"

- name: Set major openshift version from topic
  set_fact:
    major: "{{ hostvars.localhost.job_info.job.topic.name | upper | replace('OCP-', '') }}"

- name: "Work-around for 4.7 -> 4.8 upgrade"
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: gateway-mode-config
        namespace: openshift-network-operator
      data:
        mode: "local"
      immutable: true
  when:
    - '"bz2064193" in dci_workarounds|default([])'
    - major is version("4.8", "==")

- name: "Acknowledge deprecated API removals for 4.9 upgrade"
  community.kubernetes.k8s:
    definition:
      kind: ConfigMap
      metadata:
        name: admin-acks
        namespace: openshift-config
      data:
        ack-4.8-kube-1.22-api-removals-in-4.9: "true"
  when:
    - major is version("4.9", "==")

- block:
  - name: "upgrader : Fetch release digest"
    uri:
      url: "{{ webserver_url }}/{{ version }}/release.dig"
      return_content: true
    register: release_digest

  - name: "upgrader : Fetch signature for target release"
    get_url:
      url: "{{ webserver_url }}/{{ version }}/signature.yaml"
      dest: "{{ ansible_user_dir }}/clusterconfigs/signature-{{ version }}.yaml"
      mode: 0644

  - name: "upgrader : Fetch imagecontentsourcepolicy for target release"
    get_url:
      url: "{{ webserver_url }}/{{ version }}/imagecontentsourcepolicy.yaml"
      dest: "{{ ansible_user_dir }}/clusterconfigs/imagecontentsourcepolicy-{{ version }}.yaml"
      mode: 0644

  - name: "upgrader : Apply signatures to cluster"
    community.kubernetes.k8s:
      state: present
      src: "{{ ansible_user_dir }}/clusterconfigs/signature-{{ version }}.yaml"

  - name: "upgrader : Apply imagecontentsourcepolicy to cluster"
    community.kubernetes.k8s:
      state: present
      src: "{{ ansible_user_dir }}/clusterconfigs/imagecontentsourcepolicy-{{ version }}.yaml"

  - name: "Wait for updated MCP after applying an ICSP"
    include_role:
      name: check-resource
    vars:
      resource_to_check: "MachineConfigPool"
      check_wait_retries: 30
      check_wait_delay: 10
      check_reason: "Upgrade - after applying ICSP"

  - name: "upgrader : Wait for nodes to become Ready"
    community.kubernetes.k8s_info:
      kind: Node
    register: nodes_info
    vars:
      status_query: "resources[*].status.conditions[?type=='Ready'].status"
      nodes_status: "{{ nodes_info | json_query(status_query) | flatten | unique }}"
    until:
      - nodes_status == ['True']
    retries: 10
    delay: 30

  - name: "upgrader : Patch clusterversion to point to custom upstream graph"
    community.kubernetes.k8s:
      state: present
      name: version
      definition:
        kind: ClusterVersion
        spec:
          upstream: "{{ webserver_url }}/graph-{{ major }}"

  - name: "upgrader : Wait custom upstream graph update"
    community.kubernetes.k8s_info:
      kind: ClusterVersion
      name: version
    register: cluster_version
    vars:
      status_query: "conditions[?type=='RetrievedUpdates'].status"
      upgrade_status: "{{ cluster_version.resources[0].status | json_query(status_query) }}"
    until:
      - upgrade_status == ['True']
    retries: 10
    delay: 60

  when:
    - dci_disconnected | default(false) | bool

- name: "upgrader : Patch clusterversion pointing to fast channel"
  community.kubernetes.k8s:
    state: present
    name: version
    definition:
      kind: ClusterVersion
      spec:
        channel: "fast-{{ major }}"

- name: "upgrader : Get openshift-cluster-version pod name"
  community.kubernetes.k8s_info:
    kind: pod
    namespace: openshift-cluster-version
  register: ocvpod

- name: "upgrader : Delete the openshift-cluster-version pod"
  community.kubernetes.k8s:
    state: absent
    kind: pod
    namespace: openshift-cluster-version
    name: "{{ ocvpod.resources[0].metadata.name }}"

- name: "upgrader : Wait the openshift-cluster-version pod creation"
  community.kubernetes.k8s_info:
    kind: pod
    namespace: openshift-cluster-version
  register: ocvpod
  vars:
    status_query: "conditions[?type=='Ready'].status"
    pod_status: "{{ ocvpod.resources[0].status | json_query(status_query) }}"
  until:
    - pod_status == ['True']
  retries: 10
  delay: 60

- name: "upgrader : Wait for clusterversion to be refreshed"
  community.kubernetes.k8s_info:
    kind: ClusterVersion
    name: version
  register: cluster_version
  vars:
    status_query: "conditions[?type=='RetrievedUpdates'].status"
    upgrade_status: "{{ cluster_version.resources[0].status | json_query(status_query) }}"
  until:
    - upgrade_status == ['True']
  when:
    - not force_upgrade | default(false) | bool
  retries: 10
  delay: 60

- name: "upgrader : Execute the upgrade"
  vars:
    upgrade_options: >-
      {{ force_upgrade | default |
         ternary(
           '--to-image=quay.io/openshift-release-dev/ocp-release:'
             + version + '-x86_64 --force --allow-explicit-upgrade',
           '--to '+ version ) }}
  command:
    chdir: "{{ '~' + ansible_user }}/clusterconfigs/auth"
    cmd: oc adm upgrade {{ upgrade_options }}
  register: start_upgrade

- name: "upgrader : Wait for upgrade to start"
  community.kubernetes.k8s_info:
    kind: ClusterVersion
    name: version
  register: cluster_version_info
  vars:
    cluster_version_conditions: '{{ cluster_version_info.resources.0.status.conditions }}'
    condition_progressing: '{{ cluster_version_conditions | selectattr("type", "equalto", "Progressing") | first }}'
  until: ("Working towards " + version) in condition_progressing.message
  retries: 10
  delay: 30

- name: "Upgrade elapsed time"
  set_fact:
    elapsed_time: 0

- name: "Upgrader: Monitor upgrade"
  include_tasks: monitor-upgrade.yml

# Tasks to prepare operators for upgrade
- name: "Upgrader : Pre-upgrade tasks"
  include_tasks: pre-upgrade.yml

# Upgrading all operators
- name: "Upgrader : Start the upgrade on installed operators"
  include_tasks: upgrade-operators.yml
  when:
    - upgrade_operators | default(true) | bool

- name: "test_ upgrader: check if all cluster-operators are running correctly"
  community.kubernetes.k8s_info:
    kind: ClusterOperator
  register: clusteroperator_info
  vars:
    status_query: "resources[*].status.conditions[?type=='Degraded'].status"
    cluster_operators_degraded: "{{ clusteroperator_info | json_query(status_query) | flatten | unique }}"
  failed_when:
    cluster_operators_degraded == ['True']

- name: "Validate that nodes are Ready and MCPs are up to date"
  include_role:
    name: check-resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: 100
    check_wait_delay: 10
    check_reason: "Upgrade - after having operators running"

- block:
  - name: Set release_url
    set_fact:
      release_url: "{{ (webserver_url|default|length) | ternary(webserver_url|default, 'https://mirror.openshift.com/pub/openshift-v4/clients/ocp') }}"

  - name: Get the ocp client tar gunzip file
    get_url:
      url: "{{ release_url }}/{{ version }}/openshift-client-linux-{{ version }}.tar.gz"
      dest: /tmp/
      mode: '0755'

  - name: "Untar the openshift-client-linux-{{ version }}.tar.gz"
    unarchive:
      src: "/tmp/openshift-client-linux-{{ version }}.tar.gz"
      dest: "{{ dci_cluster_configs_dir }}"
      mode: '0755'
      remote_src: yes

  - name: "Remove the openshift-client-linux-{{ version }}.tar.gz"
    file:
      path: "/tmp/openshift-client-linux-{{ version }}.tar.gz"
      state: absent
  delegate_to: localhost
  when: provision_cache_store is not defined

- name: "Copy new oc client after upgrade is finished"
  vars:
    pcs: "{{ provision_cache_store | default() }}"
    oc_path: >-
      {{ pcs | length |
         ternary(
           pcs + "/" + version + "/oc",
           dci_cluster_configs_dir + "/oc" ) }}
  copy:
    src: "{{ oc_path }}"
    dest: "/usr/local/bin/oc"
    mode: "0755"
  become: true
...
