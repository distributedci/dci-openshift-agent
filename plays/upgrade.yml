---
- name: "upgrader : Get current version"
  community.kubernetes.k8s_info:
    api: config.openshift.io/v1
    kind: ClusterVersion
    name: version
  register: clusterVersion

- name: "upgrader : Get version and build from localhost vars"
  set_fact:
    version: "{{ hostvars.localhost.version_name }}"
    build: "{{ hostvars.localhost.build }}"

- name: "upgrader : Print versions"
  vars:
    - status_query: "conditions[?type=='Available'].message"
  debug:
    msg: "current={{ clusterVersion.resources[0].status | json_query(status_query) }} target={{ version }}"

- name: Set major openshift version from topic
  set_fact:
    major: "{{ hostvars.localhost.job_info.job.topic.name | upper | replace('OCP-', '') }}"

- name: "Work-around for 4.7 -> 4.8 upgrade"
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: gateway-mode-config
        namespace: openshift-network-operator
      data:
        mode: "local"
      immutable: true
  when:
    - '"bz2064193" in dci_workarounds|default([])'
    - major is version("4.8", "==")

- name: "Acknowledge deprecated API removals for 4.9 upgrade"
  community.kubernetes.k8s:
    definition:
      kind: ConfigMap
      metadata:
        name: admin-acks
        namespace: openshift-config
      data:
        ack-4.8-kube-1.22-api-removals-in-4.9: "true"
  when:
    - version is version("4.8","<=")
    - major is version("4.9", ">=")

- name: "Deactivate the upgrade of worker nodes - EUS"
  community.kubernetes.k8s:
    definition:
      kind: MachineConfigPool
      metadata:
        name: worker
      spec:
        pause: true
  when:
    - upgrade_eus | default(false) | bool

- name: "Upgrader: Running the Intermediate upgrade - EUS"
  vars:
    version: "{{ hostvars.localhost.version_inter }}" 
    target_version: "{{ major }}"
  include_tasks: upgrade-process.yml
  when:
    - upgrade_eus | default(false) | bool

- name: "Upgrader: Running the upgrade"
  vars:
    target_version: "{{ major }}"
  include_tasks: upgrade-process.yml

- name: "Reactivate the upgrade of worker nodes - EUS"
  community.kubernetes.k8s:
    definition:
      kind: MachineConfigPool
      metadata:
        name: worker
      spec:
        pause: false
  when:
    - upgrade_eus | default(false) | bool

- block:
  - name: Set release_url
    set_fact:
      release_url: "{{ (webserver_url|default|length) | ternary(webserver_url|default, 'https://mirror.openshift.com/pub/openshift-v4/clients/ocp') }}"

  - name: Get the ocp client tar gunzip file
    get_url:
      url: "{{ release_url }}/{{ version }}/openshift-client-linux-{{ version }}.tar.gz"
      dest: /tmp/
      mode: '0755'

  - name: "Untar the openshift-client-linux-{{ version }}.tar.gz"
    unarchive:
      src: "/tmp/openshift-client-linux-{{ version }}.tar.gz"
      dest: "{{ dci_cluster_configs_dir }}"
      mode: '0755'
      remote_src: yes

  - name: "Remove the openshift-client-linux-{{ version }}.tar.gz"
    file:
      path: "/tmp/openshift-client-linux-{{ version }}.tar.gz"
      state: absent
  delegate_to: localhost
  when: provision_cache_store is not defined

- name: "Copy new oc client after upgrade is finished"
  vars:
    pcs: "{{ provision_cache_store | default() }}"
    oc_path: >-
      {{ pcs | length |
         ternary(
           pcs + "/" + version + "/oc",
           dci_cluster_configs_dir + "/oc" ) }}
  copy:
    src: "{{ oc_path }}"
    dest: "/usr/local/bin/oc"
    mode: "0755"
  become: true
...
