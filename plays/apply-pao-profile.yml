---
- name: Count Nodes in the cluster
  include_tasks: plays/count_nodes.yml

- name: Increase maxUnavailable workers
  include_tasks: plays/increase_maxunavailable.yml
  when:
    - increase_unavailable_workers | default(True) | bool
    - install_type is undefined or install_type != 'sno'
    - acm_cluster_type | default('') not in ['hypershift', 'sno']

- name: Wait for Performance Addon Operator endpoint to become available
  pause:
    seconds: 60
  when:
    - install_type is defined and install_type == 'sno'
    - ocp_version_maj|int == 4
    - ocp_version_min|int <= 10

- name: Create PerformanceProfile
  community.kubernetes.k8s:
    definition: "{{ lookup('file', performance_definition) }}"
  register: profile_state
  retries: 5
  delay: 60
  until: profile_state is not failed

- name: Wait for KubeletConfig to be created in OCP <= 4.14
  include_tasks: plays/check-kubeletconfig.yml
  when:
    - ocp_version is version("4.15", "<")

- name: Pause 60 seconds to wait for MC triggered by Performance Profile starts the node changes
  pause:
    seconds: 60
  when:
    - install_type is undefined or install_type != 'sno'
    - reg_mcpool_worker.resources[0].status.machineCount >= 1 or reg_mcpool_controlplane.resources[0].status.machineCount >= 1
  no_log: true

- name: Wait for SNO node to be available
  include_tasks: plays/wait_sno_reboot.yml
  when:
    - control_plane_size | int == 1

- name: Wait for MCP status triggered by Performance Profile
  include_role:
    name: redhatci.ocp.check_resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: "{{ 16 * (groups['workers'] | default(groups['masters']) | length + 1 ) }}"
    check_wait_delay: 60
    check_reason: "PAO installation"

# In OCP >= 4.15 the PerformanceProfile triggers a first reboot and after that is completed
# the KubeletConfig object is created and nodes are rebooted again
- name: Wait for KubeletConfig to be created in OCP >= 4.15
  include_tasks: plays/check-kubeletconfig.yml
  when:
    - ocp_version is version("4.15", ">=")

- name: Wait for MCP status triggered by KubeletConfig in OCP >= 4.15
  include_role:
    name: redhatci.ocp.check_resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: "{{ 16 * (groups['workers'] | default(groups['masters']) | length + 1 ) }}"
    check_wait_delay: 60
    check_reason: "PAO installation"
  when:
    - ocp_version is version("4.15", ">=")

- name: Reset maxUnavailable count to default value 1
  community.kubernetes.k8s:
    definition:
      kind: MachineConfigPool
      metadata:
        name: worker
      spec:
        maxUnavailable: 1
...
