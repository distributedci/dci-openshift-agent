---
# This playbook is executed in the provisioner host

### Begin CNF
- name: "deploy-operators : Validate nodes for CNF"
  import_role:
    name: prepare-cnf
    tasks_from: nodes-ok.yml

- block:
  - name: "deploy-operators : Prepare cluster for CNF"
    include_role:
      name: prepare-cnf

  - name: "deploy-operators : Increase maxUnavailable count to n-1"
    shell: >
      oc patch mcp worker
      --type=merge
      -p '{"spec":{"maxUnavailable":{{ hostvars.localhost.groups['workers']|length - 1 }}}}'
    when:
    - hostvars.localhost.groups['workers']|length > 1

  - name: "deploy-operators : Install performance profile operator"
    include_role:
      name: operator-performance-profile
    when:
    - hostvars.localhost.enable_perf_addon|default(true)|bool

  - name: "deploy-operators : Install SRIOV operator"
    include_role:
      name: operator-sriov
    when:
    - hostvars.localhost.enable_sriov|default(true)|bool

  - name: "deploy-operators : Reset maxUnavailable count to default value 1"
    shell: >
      oc patch mcp worker
      --type=merge
      -p '{ "spec": { "maxUnavailable": 1 } }'

  when: hostvars.localhost.dci_prepare_cnf|bool
### End CNF

### Begin CNV
- name: "deploy-operators : Setup cluster for CNV"
  include_role:
    name: cnv-setup
  when:
  - hostvars.localhost.cnv_version is defined
### End CNV

### Begin OCS
- name: "Deploy OCS and LocalStorage"
  include_role:
    name: ocs-setup
  when:
  - hostvars.localhost.enable_ocs is defined
  - hostvars.localhost.enable_ocs | bool
### End OCS

### Begin deploy all CRs
- name: "deploy-operators : Create all Custom Resources"
  include_role:
    name: deploy-cr
  vars:
    api_version: "{{ item.api_version }}"
    kind: "{{ item.kind }}"
    namespace: "{{ item.namespace }}"
    name: "{{ item.name }}"
    spec: "{{ item.spec }}"
  with_list: "{{ hostvars.localhost.dci_ocp_custom_resources }}"
  when:
  - hostvars.localhost.dci_ocp_custom_resources is defined
  - hostvars.localhost.dci_ocp_custom_resources is list
### End Deploy all CRs
...
