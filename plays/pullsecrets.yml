---
- name: "Append openshift_secret and disconnected_auths to DCI Job pull_secret"
  vars:
    dci_os: "{{ job_info.job.topic.data.pull_secret | default({}) | combine(openshift_secret | default({}), recursive=True) }}"
  set_fact:
    pullsecret: "{{ dci_os | combine({'auths': disconnected_auths | default({})}, recursive=True) }}"
  no_log: true

- name: "Remove cloud.openshift.com auth in disconnected"
  set_fact:
    pullsecret: |
      {
        "auths": {
        {% for repo in pullsecret.auths | list %}
          {% if repo != "cloud.openshift.com" %}
            "{{ repo }}": {{ pullsecret.auths[repo] | to_json }}{% if loop.last %}{% else %},{% endif %}
          {% endif %}
        {% endfor %}
        }
      }
  no_log: true
  when:
    - dci_disconnected | default(false) | bool

- name: "Set temp file with DCI Job creds + auth vars"
  tempfile:
    state: file
    prefix: "dci_auth_vars"
  register: dci_auth_vars
  no_log: true

- name: "Save DCI + openshift_secret + disconnected_auths into a temp file"
  copy:
    content: "{{ pullsecret }}"
    dest: "{{ dci_auth_vars.path }}"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0400"
    force: true

- name: "Set auth files paths"
  set_fact:
    auth_paths: "{{ [dci_auth_vars.path] }}"

- name: "Check if {{ pullsecret_file }} file exists"
  stat:
    path: "{{ pullsecret_file }}"
    get_checksum: false
  register: pullfile
  when:
    - pullsecret_file is defined

- name: "Append {{ pullsecret_file }} to the list of auths to combine"
  set_fact:
    auth_paths: "{{ auth_paths + [ pullsecret_file ] }}"
  when:
    - pullsecret_file is defined
    - pullfile.stat.exists

- name: "Combine auth files"
  include_role:
    name: merge-registry-creds
  vars:
    mrc_auth_files: "{{ auth_paths }}"

- name: "Delete dci_auth_vars file"
  file:
    path: "{{ dci_auth_vars.path }}"
    state: absent
...