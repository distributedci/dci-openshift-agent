---
- name: Check the variables needed to add host
  fail:
    msg: "variable {{ item }} not defined"
  when: item is not defined
  with_items:
    - _sut
    - _ssh_private_key

- name: Update inventory based on virsh state
  block:
    - name: Fetch IP address given by libvirt
      become: true
      ansible.builtin.shell: >-
        virsh domifaddr {{ _sut.name }} --source arp |
        awk '/ipv4/ { gsub("/.*", "", $4); print $4 }'
      register: virsh
      until: virsh.rc == 0
      retries: 60 # wait up to 10 minutes for the VM to get an address
      delay: 10

    - name: Register {{ _sut.name }} as a new ansible host
      ansible.builtin.add_host:
        name: "{{ _sut.name }}"
        ansible_host: "{{ virsh.stdout }}"
        ansible_user: redhat
        ansible_ssh_command_args: "-o StrictHostKeyChecking=no"
        ansible_ssh_private_key_file: "{{ _ssh_private_key }}"
        groups: microshift

    - name: Wait for {{ _sut.name }} to be ready
      ansible.builtin.wait_for:
        host: "{{ virsh.stdout }}"
        port: 22
