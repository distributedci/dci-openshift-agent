---
- name: Punch a hole in the firewall for OCP API
  become: yes
  ansible.posix.firewalld:
    zone: public
    port: 6443/tcp
    state: enabled
    permanent: true
    immediate: true

- name: Set facts
  ansible.builtin.set_fact:
    remote_kc: "/var/lib/microshift/resources/kubeadmin/kubeconfig-{{ inventory_hostname }}"

- name: Copy kubeconfig to a second location to correct hostname
  become: true
  ansible.builtin.copy:
    src: /var/lib/microshift/resources/kubeadmin/kubeconfig
    dest: "{{ remote_kc }}"
    remote_src: true

- name: Sanitize API endpoint
  become: true
  ansible.builtin.replace:
    path: "{{ remote_kc }}"
    regexp: "localhost"
    replace: "{{ hostvars[inventory_hostname]['ansible_host'] }}"

- name: Download kubeconfig to clusterconfigs directory
  become: true
  ansible.builtin.fetch:
    src: "{{ remote_kc }}"
    dest: "{{ dci_cluster_configs_dir }}/kubeconfig-{{ inventory_hostname }}"
    flat: true
...
