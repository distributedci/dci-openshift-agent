---
- name: "Create {{ customize_extramanifests_path }} directory if it does not exist"
  file:
    path: "{{ customize_extramanifests_path }}"
    state: directory
    mode: '0755'
  when:
    - customize_extramanifests_path is defined

- name: Set console password for core user >= 4.13
  vars:
    core_pass: "$6$uHw2510iZlY8uBFL$96BDGgCnKnZ7Cudk82NUfdSllh\
                keiEnwOctdW2Oo15OVxjy9QPq3YKdnAm5PG5NZxkyI8EPC0hjdicMUMbpx10"
  ansible.builtin.copy:
    content: |
      apiVersion: machineconfiguration.openshift.io/v1
      kind: MachineConfig
      metadata:
        labels:
          machineconfiguration.openshift.io/role: worker
        name: set-core-user-password
      spec:
        config:
          ignition:
            version: 3.4.0
          passwd:
            users:
            - name: core
              passwordHash:{{ core_pass }}
    dest: "{{ customize_extramanifests_path }}/set-console-pass.yaml"
    mode: "0644"
  when:
    - version is version('4.13', '>=')

- name: Set console password for core user < 4.13
  vars:
    core_pass: "Y29yZTokNiR1SHcyNTEwaVpsWTh1QkZMJDk2QkRHZ0NuS25aN0N1ZGs\
                4Mk5VZmRTbGxoa2VpRW53T2N0ZFcyT28xNU9WeGp5OVFQcTNZS2RuQW\
                01UEc1Tlp4a3lJOEVQQzBoamRpY01VTWJweDEw"
  ansible.builtin.copy:
    content: |
      apiVersion: machineconfiguration.openshift.io/v1
      kind: MachineConfig
      metadata:
        labels:
          machineconfiguration.openshift.io/role: worker
        name: 99-worker-set-core-passwd
      spec:
        config:
          ignition:
            version: 3.2.0
          storage:
            files:
            - contents:
                source: data:text/plain;charset=utf-8;base64,{{ core_pass }}
              mode: 420
              overwrite: true
              path: /etc/core.passwd
          systemd:
            units:
            - name: set-core-passwd.service
              enabled: true
              contents: |
                [Unit]
                Description=Set 'core' user password for out-of-band login
                [Service]
                Type=oneshot
                ExecStart=/bin/sh -c 'chpasswd -e < /etc/core.passwd'
                [Install]
      WantedBy=multi-user.target
    dest: "{{ customize_extramanifests_path }}/set-console-pass.yaml"
    mode: "0644"
  when:
    - version is version('4.13', '<')
...

