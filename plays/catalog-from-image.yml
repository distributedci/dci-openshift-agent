---
- name: "Build catalog from upstream only for non-GA OCP versions"
  vars:
    short_ver: "{{ '.'.join(version.split('-')[0].split('.')[:2]) }}"
  include_tasks: build-upstream-catalog.yml
  when:
    - (dci_disconnected | default(false) | bool) or (dci_local_registry | length)
    - short_ver is version("4.14", ">=")

- name: "Get the operators mirror-list"
  include_tasks: get-mirror-list.yml
  when:
    - dci_disconnected | default(false) | bool

- name: "Prune catalog and mirror the Red Hat operators"
  block:
    - name: "Build pruned catalog"
      include_tasks: build-catalog.yml

    - name: "Mirror pruned catalog"
      include_role:
        name: mirror-catalog
      vars:
        mc_oc_tool_path: "{{ oc_tool_path }}"
        mc_catalog: "{{ dci_local_registry }}{{ opm_local_registry_path }}:{{ index_tag }}"
        mc_registry: "{{ dci_local_registry }}"
        mc_pullsecret: "{{ dci_pullsecret_file }}"

    - name: "Append the ImageContentSourcePolicy file"
      set_fact:
        icsp_files: "{{ icsp_files | default([]) + [mc_icsp_file.path] }}"
      when: mc_icsp_file is defined
  when:
    - dci_disconnected | default(false) | bool
    - mirror_list is defined
    - mirror_list | length

- name: "Configure Red Hat catalogSources for disconnected environments"
  block:
    - name: "Disable default catalog sources for disconnected deployment"
      community.kubernetes.k8s:
        definition:
          apiVersion: config.openshift.io/v1
          kind: OperatorHub
          metadata:
            name: cluster
          spec:
            disableAllDefaultSources: true

    - name: "Validate Red Hat catalogSources are disabled"
      community.kubernetes.k8s_info:
        api: operators.coreos.com/v1alpha1
        kind: CatalogSource
        namespace: openshift-marketplace
      register: catalogs_list
      until:
        - catalogs_list.resources is defined
        - catalogs_list.resources | length == 0
      retries: 6
      delay: 10
      when:
        - dci_main == 'install'

    - name: "Create Red Hat disconnected catalogSource"
      include_role:
        name: catalog-source
      vars:
        cs_name: "{{ opm_catalog_source_name }}"
        cs_namespace: "{{ opm_catalog_source_namespace }}"
        cs_image: "{{ dci_local_registry }}{{ opm_local_registry_path }}:{{ index_tag }}"
        cs_publisher: "Red Hat Operators"
      when:
        - mirror_list is defined
        - mirror_list | length
  when:
    - dci_disconnected | default(false) | bool
...
