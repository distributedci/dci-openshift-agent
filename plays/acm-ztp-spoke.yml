- name: Install local Git service
  ansible.builtin.include_role:
    name: redhatci.ocp.git_on_ocp
    apply:
      environment:
        - KUBECONFIG: "{{ hub_kubeconfig_path }}"
  when: enable_git_on_ocp | default(false) | bool

- name: Push the ZTP site-config manifest
  ansible.builtin.include_role:
    name: redhatci.ocp.configure_ztp_gitops_repo
  vars:
    target_ztp_gitops_repo_dst_branch: "{{ dci_gitops_sites_repo.branch }}"
    target_ztp_gitops_repo_src_branch: "{{ dci_gitops_sites_repo.src_branch }}"
    target_ztp_gitops_repo: "{{ dci_gitops_sites_repo.url }}"
  when: dci_gitops_sites_repo.src_branch is defined

- name: Load the SSH key to access the repository
  ansible.builtin.include_role:
    name: redhatci.ocp.gitops_configure_repo
  vars:
    gitlab_ssh_known_hosts: "{{ dci_gitops_sites_repo.known_hosts }}"
    gitlab_key_path: "{{ dci_gitops_sites_repo.key_path }}"
    ztp_gitops_repo: "{{ dci_gitops_sites_repo.url }}"

- name: Create the Spoke cluster namespace
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ dci_ztp_spoke_namespace }}"

- name: Create the Spoke cluster pull-secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: assisted-deployment-pull-secret
        namespace: "{{ dci_ztp_spoke_namespace }}"
      data:
        .dockerconfigjson: "{{ hub_pull_secret.resources[0].data['.dockerconfigjson'] }}"

- name: Create the Spoke cluster Baremetal Host credentials
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ cluster }}-bmh-secret"
        namespace: "{{ dci_ztp_spoke_namespace }}"
      data:
        username: "{{ hostvars[groups.spoke_nodes[0]].bmc_user | b64encode }}"
        password: "{{ hostvars[groups.spoke_nodes[0]].bmc_password | b64encode }}"
      type: Opaque

- name: Create the openshit-gitops-operator apps
  ansible.builtin.include_role:
    name: redhatci.ocp.configure_ztp_gitops_apps
  vars:
    kubeconfig_path: "{{ hub_kubeconfig_path }}"
    podman_runner: jumpbox
    ocp_pull_secret: "{{ hub_pull_secret.resources[0].data['.dockerconfigjson'] | b64decode }}"
    ztp_site_generator_image: registry.redhat.io/openshift4/ztp-site-generate-rhel8
    ztp_site_generator_version: "v{{ job_info.job.topic.name | ansible.builtin.regex_replace('OCP-', '') }}"
    ztp_sites_path: "{{ dci_gitops_sites_repo.path}}"
    ztp_sites_gitops_repo: "{{ dci_gitops_sites_repo.url }}"
    ztp_sites_branch: "{{ dci_gitops_sites_repo.branch }}"
    ztp_policies_path: "{{ dci_gitops_policies_repo.path}}"
    ztp_policies_gitops_repo: "{{ dci_gitops_policies_repo.url }}"
    ztp_policies_branch: "{{ dci_gitops_policies_repo.branch }}"

- name: Wait for the hosts to get provisioned
  kubernetes.core.k8s_info:
    api: metal3.io/v1alpha1
    kind: BareMetalHost
    name: "{{ groups['spoke_nodes'][0].inventory_name }}.{{ domain }}"
    namespace: "{{ cluster }}"
  register: hosts_provisioned
  delay: 30
  retries: 60
  until:
    - hosts_provisioned

- name: Wait for the deployment to start
  kubernetes.core.k8s_info:
    api: extensions.hive.openshift.io/v1beta1
    kind: AgentClusterInstall
    name: "{{ cluster }}"
    namespace: "{{ cluster }}"
  register: install_started
  delay: 10
  retries: 30
  until:
    - install_started.resources is defined
    - install_started.resources | length > 0

- name: "Monitor: Set monitoring facts"
  ansible.builtin.set_fact:
    elapsed_time: 0
    node_rebooted: false

- name: Monitor installation
  ansible.builtin.include_role:
    name: redhatci.ocp.acm_sno
    tasks_from: monitor-install
  vars:
    acm_cluster_name: "{{ cluster }}"

- name: Get Spoke cluster credentials
  ansible.builtin.include_role:
    name: redhatci.ocp.acm_sno
    tasks_from: get-credentials
  vars:
    acm_cluster_name: "{{ cluster }}"