---
- name: Set pullsecret from job_info
  set_fact:
    pull_secret: "{{ job_info.job.topic.data.pull_secret | default({}) | combine(openshift_secret | default({}), recursive=True) }}"

- name: "Copy auths fact content to a file"
  copy:
    content: "{{ pull_secret | to_json }}"
    dest: "{{ dci_cluster_configs_dir }}/pull-secret.txt"
    mode: '0644'
    force: true

- name: "Set dci_pullsecret_file fact"
  set_fact:
    dci_pullsecret_file: "{{ dci_cluster_configs_dir }}/pull-secret.txt"
    local_pull_secret_path: "{{ dci_cluster_configs_dir }}/pull-secret.txt"
  no_log: true

- name: "Set registry_url"
  set_fact:
    registry_path: "docker://{{ local_registry_host | default('localhost') }}:{{ local_registry_port | default(0)  }}/{{ hostvars[groups['registry_host'][0]].local_repo | default('') }}"

- name: "Mirror OCP release artifacts"
  include_role:
    name: mirror-ocp-release
  vars:
    version: "{{ hostvars.localhost.version }}"
    release_url: "{{ hostvars.localhost.url }}"
    webserver_url: "{{ hostvars.localhost.webserver_url | default(None) }}"
    cache_dir: "{{ hostvars.localhost.provision_cache_store | default((ansible_env.HOME, 'releases') | join('/')) }}"
    registry_url: "{{ registry_path }}"
    auths_file: "{{ dci_pullsecret_file }}"
    force: "{{ (hostvars.localhost.dci_force_mirroring | default(false)) or (hostvars.localhost.build == 'candidate') | bool }}"
    mirror_artifacts: "{{ dci_disconnected | default(False) | bool }}"
    unpack_artifacts: "{{ dci_disconnected | default(False) | bool }}"
    install_type: "{{ hostvars.localhost.install_type | default('ipi') }}"
    mirror_disk_images: "{{ dci_disconnected | default(False) | bool }}"
    mirror_container_images: "{{ dci_disconnected | default(False) | bool }}"
    write_custom_config: false

- name: "Set facts for install via ACM - disconnected"
  set_fact:
    acm_metal_iso_location: "{{ webserver_url }}/{{ ocp_release_data['rhcos_images']['metal_iso_location'] | basename }}"
    acm_rootfs_url: "{{ webserver_url }}/{{ ocp_release_data['rhcos_images']['metal_pxe_rootfs_location'] | basename }}"
    acm_release_image: "{{ registry_path | urlsplit('netloc') }}{{ registry_path | urlsplit('path') }}:{{ version }}"
  when:
    - dci_disconnected | default(False) | bool

- name: "Set facts for install via ACM - connected"
  set_fact:
    acm_metal_iso_location: "{{ hostvars.localhost.ocp_release_data.rhcos_images.metal_iso_location }}"
    acm_rootfs_url: "{{ hostvars.localhost.ocp_release_data.rhcos_images.metal_pxe_rootfs_location }}"
    acm_release_image: "{{ ocp_release_data['container_image'] | quote }}"
  when:
    - not dci_disconnected | default(False) | bool
...
