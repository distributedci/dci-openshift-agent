- name: "Upgrading Operator {{ sub.subscriptionName }}"
  debug:
    msg: "{{ sub.subscriptionName }}"

- name: Wait for current CSV to be updated
  community.kubernetes.k8s_info:
    api: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ sub.namespace }}"
    name: "{{ sub.subscriptionName }}"
  register: sub_update
  retries: 10
  delay: 10
  until:
    - sub_update.resources is defined
    - sub_update.resources | length == 1
    - "'status' in sub_update.resources[0]"
    - "'currentCSV' in sub_update.resources[0].status"
    - sub_update.resources[0].status.currentCSV != sub.installedCSV
  # We don't trigger a failure if the currentCSV and installedCSV are set to
  # the same value, since it may happen a cluster upgrade does not include an
  # operator upgrade.
  failed_when: >
    sub_update.resources is unefined or
    sub_update.resources[0].status is undefined or
    sub_update.resources[0].status.currentCSV is undefined or
    sub_update.resources[0].status.currentCSV == ""

- name: "Get operator's CSV for desired channel"
  set_fact:
    operator_csv: "{{ sub_update.resources[0].status.currentCSV  }}"

- name: "Upgrade operator if the current CSV is different to the installed one"
  when : operator_csv != sub.installedCSV
  block:

    # Versions may not follow the same convention between releases
    # Need to delete the non approved install plan, once the subscriptions InstallPlan is set to Automatic
    # the install plans will be automatically approved in order to get the latest CSV version according to what
    # is defined in the upgrade graphs.
    - name: "Get Install plans"
      community.kubernetes.k8s_info:
        api: operators.coreos.com/v1alpha1
        kind: InstallPlan
        namespace: "{{ sub.namespace }}"
      register: install_plans
      retries: 5
      delay: 5

    - name: "Filter install plans details"
      vars:
        ip_details: "resources[*].{ ipName: metadata.name, approved: spec.approved}"
      set_fact:
        ips: "{{ install_plans | json_query(ip_details) }}"
      retries: 5
      delay: 5

    - name: "Change Subscription to Automatic and update channel"
      community.kubernetes.k8s:
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: "{{ sub.subscriptionName }}"
            namespace:  "{{ sub.namespace }}"
          spec:
            name: "{{ sub.operatorName }}"
            installPlanApproval: "Automatic"
            channel: "{{ default_channel }}"

    - name: "Delete non-approved install plans"
      community.kubernetes.k8s:
        api: operators.coreos.com/v1alpha1
        kind: InstallPlan
        namespace: "{{ sub.namespace }}"
        name: "{{ ip.ipName }}"
        state: absent
      retries: 5
      delay: 5
      loop: "{{ ips }}"
      loop_control:
        loop_var: ip
        label: "{{ ip.ipName }}"
      when: not ip.approved | bool

    - name: "Upgrade details"
      debug:
        msg: "Upgrading from {{ sub.installedCSV }} to {{ operator_csv }}"

    - name: "Wait up to 2 hours for new operator's CSV to be ready"
      community.kubernetes.k8s_info:
        api: operators.coreos.com/v1alpha1
        namespace: "{{ sub.namespace }}"
        kind: ClusterServiceVersion
        name: "{{ operator_csv }}"
      register: csv
      retries: 120
      delay: 60
      until:
        - csv.resources is defined
        - csv.resources | length == 1
        - "'status' in csv.resources[0]"
        - "'phase' in csv.resources[0].status"
        - csv.resources[0].status.phase in ['Succeeded', 'Present']

    - name: "Set install_approval to its original mode"
      community.kubernetes.k8s:
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: "{{ sub.subscriptionName }}"
            namespace:  "{{ sub.namespace }}"
          spec:
            name: "{{ sub.operatorName }}"
            installPlanApproval: "{{ sub.installPlanApproval }}"
...
