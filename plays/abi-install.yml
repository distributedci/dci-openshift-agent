---
# Validate that ocp version is > 4.12

- name: Add Bastion host to provisioner group
  add_host:
    hostname: "{{ item }}"
    groups:
      - provisioner
  loop: "{{ groups['bastions'] }}"
  when:
    - "'provisioner' not in groups"

- name: Set installer path
  vars:
    installer_file: >-
      {{ version is version('4.16', '>=') |
      ternary('openshift-install', 'openshift-baremetal-install') }}
  set_fact:
    openshift_installer_path: "{{ provision_cache_store | default((ansible_env.HOME, 'releases') | join('/')) }}/{{ version }}/{{ installer_file }}"

- name: Check extracted installer has agent subcommand
  ansible.builtin.shell:
    cmd: "{{ openshift_installer_path }} agent --help"
  register: agent_check
  failed_when: false

- name: Set registry_repository fact for install playbooks in disconnected mode
  set_fact:
    registry_repository: >
      {{ hostvars[groups['registry_host'][0]].local_repo |
      default('ocp-'+ version.split('.')[:2] |
      join('.') +'/'+ version, true) }}
  when: dci_disconnected | default(False) | bool

- name: "Prereq facts check"
  vars:
    pull_secret: "{{ dci_pullsecret }}"
    ssh_public_check: "{{ not (generate_ssh_keys | default(True)) }}"
    mirror_certificate_check: "{{ ((use_local_mirror_registry | default(False)) == True) and ((setup_registry_service | default(True)) == False) }}"
  include_role:
    name: redhatci.ocp.prereq_facts_check

- name: "Parse openshift version"
  vars:
    openshift_full_version: "{{ version }}"
    repo_root_path: "{{ dci_cluster_configs_dir }}"
  include_role:
    name: redhatci.ocp.populate_mirror_registry
    tasks_from: var_check.yml

- name: Generate_manifests
  vars:
    pull_secret: "{{ dci_pullsecret }}"
    repo_root_path: "{{ dci_cluster_configs_dir }}"
  include_role:
    name: redhatci.ocp.generate_manifests

- name: Generate agent ISO
  vars:
    pull_secret: "{{ local_pull_secret }}"
    repo_root_path: "{{ dci_cluster_configs_dir }}"
    agent_based_installer_path: "{{ openshift_installer_path }}"
  include_role:
    name: redhatci.ocp.generate_agent_iso

- name: "Fail playbook without boot_iso_url"
  fail:
    msg="Missing argument: this playbook requires 'boot_iso' to be defined with the URL of the ISO to boot the systems"
  when: boot_iso_url is not defined

- name: Boot nodes using the ISO
  ansible.builtin.include_role:
    name: "redhatci.ocp.vendors.{{ hostvars[target_host]['vendor'] | lower }}"
    tasks_from: iso.yml
  loop: "{{ groups['nodes'] }}"
  loop_control:
    loop_var: target_host

- name: Monitor Agent Based Installer
  vars:
    agent_based_installer_path: "{{ openshift_installer_path }}"
    repo_root_path: "{{ dci_cluster_configs_dir }}"
  include_role:
    name: redhatci.ocp.monitor_agent_based_installer

- name: Copy generated kubeconfig (ABI)
  copy:
    src: "{{ repo_root_path }}/generated/{{ cluster_name }}/auth/kubeconfig"
    dest: "{{ kubeconfig_path }}"
    mode: '0664'

- name: Read Kubeadmin Credentials
  slurp:
    src: "{{ dci_cluster_configs_dir }}/generated/{{ cluster_name }}/auth/kubeadmin-password"
  register: kubeadmin_password

- name: Set credentials map
  set_fact:
    kubeadmin_credentials:
      username: kubeadmin
      password: "{{ kubeadmin_password.content | b64decode }}"
      console_url: "https://console-openshift-console.apps.{{ cluster_name }}.{{ base_dns_domain }}"
  no_log: true

- name: Save credentials to file
  copy:
    content: "{{ kubeadmin_credentials | to_yaml }}"
    dest: "{{ dci_cluster_configs_dir }}/kubeadmin-password"
    mode: "0600"
...
