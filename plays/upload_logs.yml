---
- name: Generate tempfile
  tempfile:
    state: file
    suffix: temp
  register: tempfile

- name: Generate inventory_file json
  copy:
    content: |
      <script type="application/json" id="inventory">
      {
        "inventory_file": "{{ hostvars[groups['provisioner'][0]].inventory_file }}"
      }
      </script>
    dest: "{{ tempfile.path }}"

- name: Upload inventory_file to DCI Control Server
  environment:
    - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
    - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
    - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
  dci_file:
    path: "{{ tempfile.path }}"
    name: "inventory_file.json"
    job_id: "{{ hostvars.localhost.job_id }}"
    mime: "application/json"

- name: Remove tempfile
  file:
    path: "{{ tempfile.path }}"
    state: absent
