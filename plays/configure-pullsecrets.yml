---
- name: Set pullsecret from job_info - Connected
  set_fact:
    pullsecret: "{{ job_info.job.topic.data.pull_secret | default({}) | combine(openshift_secret | default({}), recursive=True) }}"
  no_log: true
  when:
    - not (dci_disconnected | default(false) | bool)

# Removing secret for cloud.openshift.com in order to disable the insights operator
- name: Set pullsecret from job_info - Disconnected
  vars:
    dci_pullsecret: "{{ job_info.job.topic.data.pull_secret | default({}) | combine(openshift_secret | default({}), recursive=True) }}"
  set_fact:
    pullsecret: |
      {
        "auths": {
        {% for repo in dci_pullsecret.auths | list %}
          {% if repo != "cloud.openshift.com" %}
            "{{ repo }}": {{ dci_pullsecret.auths[repo] | to_json }}{% if loop.last %}{% else %},{% endif %}
          {% endif %}
        {% endfor %}
        }
      }
  no_log: true
  when:
    - dci_disconnected | default(false) | bool

- name: Read Disconnected auths
  include_vars:
    file: "{{ hostvars[groups['registry_host'][0]].disconnected_registry_auths_file }}"
    name: disconnected_auths
  no_log: true
  when:
    - dci_disconnected | default(false) | bool

- name: "Check if {{ pullsecret_file }} exists"
  stat:
    path: "{{ pullsecret_file }}"
    get_checksum: false
  register: pullfile
  when:
    - pullsecret_file is defined

- name: "Set dci_pullsecret_file if pullsecret_file var exists"
  block:
    - name: "Copy pull secret file to cache directory"
      copy:
        src: "{{ pullsecret_file }}"
        dest: "{{ provision_cache_store }}/pull-secret.txt"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: '0644'
        force: true

    - name: "Set dci_pullsecret_file fact"
      set_fact:
        dci_pullsecret_file: "{{ pullsecret_file }}"
      no_log: true
  when:
    - pullsecret_file is defined
    - pullfile.stat.exists | bool

- name: "Set auths fact if pullsecret_file var is not present"
  block:
    - name: "Combine pull secret and disconnected_auths vars"
      set_fact:
        auths: "{{ pullsecret | combine({'auths': hostvars.localhost.disconnected_auths}, recursive=True) }}"
      no_log: true

    - name: "Copy auths fact content to a file"
      copy:
        content: "{{ auths }}"
        dest: "{{ provision_cache_store }}/pull-secret.txt"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: '0644'
        force: true

    - name: "Set dci_pullsecret_file fact if pullsecret_file is not present"
      set_fact:
        dci_pullsecret_file: "{{ provision_cache_store }}/pull-secret.txt"
      no_log: true
  when:
    - dci_disconnected | default(false) | bool
    - pullsecret_file is undefined

- name: "Create releases dir in home directory if needed"
  file:
    path: "{{ (ansible_env.HOME, 'releases') | join('/') }}"
    state: directory
    mode: "0775"
  when:
    - provision_cache_store is undefined

- name: "Set dci_pullsecret_file in connected environments"
  block:
    - name: "Copy pullsecret fact content to a file"
      copy:
        content: "{{ pullsecret }}"
        dest: "{{ hostvars.localhost.provision_cache_store | default((ansible_env.HOME, 'releases') | join('/')) }}/pull-secret.txt"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: '0644'
        force: true

    - name: "Set dci_pullsecret_file fact if pullsecret_file is not present"
      set_fact:
        dci_pullsecret_file: "{{ hostvars.localhost.provision_cache_store | default((ansible_env.HOME, 'releases') | join('/')) }}/pull-secret.txt"
      no_log: true
  when:
    - not (dci_disconnected | default(false) | bool)
    - pullsecret_file is undefined
...
