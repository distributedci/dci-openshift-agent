---
- name: Set outputs to be copied
  set_fact:
    outputs:
      kubeconfig: "{{ dci_cluster_configs_dir }}/kubeconfig"

- name: "Setup Advanced Cluster Management"
  include_role:
    name: redhatci.ocp.acm_setup
  vars:
    hub_disconnected: "{{ dci_disconnected | default(false) | bool }}"
  when:
    - enable_acm | bool

- name: Copy outputs if defined
  copy:
    src: "{{ outputs[item.key] }}"
    dest: "{{ item.value }}"
    mode: "0644"
  with_dict: "{{ job_info.outputs }}"
  when: job_info.outputs is defined and job_info.outputs != None

- name: Get the differences from the previous DCI job
  shell: "dci-diff-jobs --job_id_1 {{ job_id }} > {{ job_logs.path }}/diff-jobs.txt"
  ignore_errors: true

- name: Save job info in the cluster
  block:
    - name: "Create DCI namespace"
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: openshift-dci

    - name: "Create DCI configmap"
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "doa-{{ ansible_date_time.epoch }}"
            namespace: openshift-dci
          data:
            job_info: "{{ job_info | to_json }}"
  when: dci_cluster_metadata | default(false) | bool

...
