---
- name: Set outputs to be copied
  set_fact:
    outputs:
      kubeconfig: "{{ dci_cluster_configs_dir }}/kubeconfig"

- name: Copy outputs if defined
  copy:
    src: "{{ outputs[item.key] }}"
    dest: "{{ item.value }}"
    mode: "0644"
  with_dict: "{{ job_info.outputs }}"
  when: job_info.outputs is defined and job_info.outputs != None

- name: Get the differences from the previous DCI job
  shell: "dci-diff-jobs --job_id_1 {{ job_id }} > {{ job_logs.path }}/diff-jobs.txt"
  ignore_errors: true

- name: Apply Work-around OCPBUGS-30899 for ovn issues
  when:
    - dci_workarounds is defined
    - '"OCPBUGS-30899" in dci_workarounds'
  block:
    - name: Get OVN pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "openshift-ovn-kubernetes"
        label_selectors:
          - app = ovnkube-node
      register: pods_info

    - name:  Restart OVN pods
      kubernetes.core.k8s:
        wait: true
        state: absent
        definition:
          apiVersion: v1
          kind: Pod
          metadata:
            name: "{{ item.metadata.name }}"
            namespace: "openshift-ovn-kubernetes"
      loop: "{{ pods_info.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"

    - name: Wait for OVN pods to be running
      vars:
        containers_query: "resources[*].status.containerStatuses[*].ready"
        pods_query: "resources[*].status.phase"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "openshift-ovn-kubernetes"
        label_selectors:
          - app = ovnkube-node
      register: ovn_pods
      until:
        - ovn_pods is defined
        - ovn_pods.resources is defined
        - ovn_pods.resources | length > 0
        - ovn_pods | json_query(containers_query) | flatten | unique == [true]
        - ovn_pods | json_query(pods_query) | flatten | unique == ['Running']
      retries: 5
      delay: 5
...
