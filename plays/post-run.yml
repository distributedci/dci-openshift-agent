---

- name: Upload the rhcos_kernel component if possible
  block:
    - name: Get nodes information
      community.kubernetes.k8s_info:
        kind: Node
      register: nodes_info

    - name: Create component with the rhcos kernel used
      vars:
        - kernel_version: "{{ nodes_info.items[0].status.nodeInfo.kernelVersion }}"
      environment:
        - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
        - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
        - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
      dci_component:
        name: "rhcos_kernel {{ kernel_version }}"
        canonical_project_name: "rhcos_kernel {{ kernel_version }}"
        team_id: "{{ job_info['job']['team_id'] }}"
        topic_id: "{{ job_info['job']['topic_id'] }}"
        type: kernel
        state: present
  ignore_errors: yes

- name: Set outputs to be copied
  set_fact:
    outputs:
      kubeconfig: "~/clusterconfigs/auth/kubeconfig"

- name: Copy outputs if defined
  delegate_to: "{{ groups['provisioner'][0] }}"
  fetch:
    src: "{{ outputs[item.key] }}"
    dest: "{{ item.value }}"
    flat: true
  with_dict: "{{ job_info.outputs }}"
  when: job_info.outputs is defined and job_info.outputs != None

...
