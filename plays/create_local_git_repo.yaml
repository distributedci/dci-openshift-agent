# We need to create a local github repo as we need to build dpdk using S2I build config
---
- block:
  - name: Install packages needed for testing
    package:
      name: "{{ item }}"
      state: present
    become: true
    with_items:
      - git
      - httpd-tools
      - httpd

  - name: Create a git.conf file
    shell: |
        echo  "<VirtualHost *:80>
        SetEnv GIT_PROJECT_ROOT /var/www/git
        SetEnv GIT_HTTP_EXPORT_ALL
        DocumentRoot /var/www/git
        ScriptAlias / /usr/libexec/git-core/git-http-backend/

        <Directory "/usr/libexec/git-core">
        Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
        AllowOverride None
        Require all granted
        </Directory>
        <Directory "/var/www/git">
        Dav On
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
        </Directory>
        </VirtualHost>" > /etc/httpd/conf.d/git.conf
    become: true

  - name: Create root directory for git repo
    file:
      path: /var/www/git
      state: directory
    become: true

  - name: Configure selinux for /var/www/git dir
    shell: >
      semanage fcontext -m -t httpd_sys_rw_content_t
      "/var/www/git(/.*)?"
    become: true

  - name: Run restorecon
    shell: sudo restorecon -Rv /var/www/git
    become: true

  - name: Restart and enable httpd service
    shell: |
      systemctl restart httpd
      systemctl enable httpd
    become: true

  - name: Configure firewall to allow port 80
    shell: firewall-cmd --add-service=http --permanent
    become: true

  - name: Reload firewall
    shell: firewall-cmd --reload
    become: true

  - name: Remove git repo if already cloned
    file:
        path: /var/www/git/cnf-features-deploy.git
        state: absent
    become: true

  - name: Remove previously cloned files
    file:
        path: /var/www/git/cnf-features-deploy
        state: absent
    become: true

  - name: Clone cnf-features-deploy from upstream to local
    git:
      version: "{{ cnf_features_deploy_branch }}"
      repo: "{{ cnf_features_deploy_repo }}"
      dest: "/var/www/git/cnf-features-deploy"
      force: yes
    # On RHEL8 git clone can sporadically fail with OpenSSL SSL_read:
    # SSL_ERROR_SYSCALL, errno 104. This is a workaround to try cloning the repo
    # multiple times.
    register: cnf_features_deploy_local_clone
    retries: 3
    delay: 10
    become: true

  - name: Append cloned directory name with .git
    shell: mv /var/www/git/cnf-features-deploy /var/www/git/cnf-features-deploy.git
    become: true

  - name: Perform git init and configure it
    shell: |
     cd /var/www/git/cnf-features-deploy.git
     git init --bare &> /dev/null
     touch git-daemon-export-ok
     cp hooks/post-update.sample hooks/post-update
     git config http.receivepack true
     git config http.uploadpack true
     git update-server-info
     git remote set-url origin {{ dci_baseurl }}/cnf-features-deploy.git
     chown -Rf apache:apache /var/www/git/cnf-features-deploy.git
    become: true

  - name: Add and push cnf-feature repo to our locally created github repo
    shell: |
      cd /var/www/git/cnf-features-deploy.git
      git add .
      git commit -m 'initial commit'
      git push origin
    become: true

  when:
    - dci_openshift_agent_cnf_tests_mode is defined and dci_openshift_agent_cnf_tests_mode == "disconnected"

