---
- name: "Disable SR-IOV Draining in SNO"
  community.kubernetes.k8s:
    definition:
      apiVersion: sriovnetwork.openshift.io/v1
      kind: SriovOperatorConfig
      metadata:
        name: default
        namespace: openshift-sriov-network-operator
      spec:
        disableDrain: true
  when:
    - install_type is defined
    - install_type == "sno"

- name: Get all nodes
  community.kubernetes.k8s_info:
    kind: Node
  register: nodes

- name: Add sriov label to worker nodes
  shell: |
    oc label node {{ item.metadata.name }} feature.node.kubernetes.io/network-sriov.capable="true"
  when:
    - "'node-role.kubernetes.io/worker' in item.metadata.labels"
    - "'feature.node.kubernetes.io/network-sriov.capable' not in item.metadata.labels"
  loop: "{{ nodes.resources }}"

- name: "Check SriovNetworkNodeState application for all workers"
  include_role:
    name: check-resource
  vars:
    resource_to_check: "SriovNetworkNodeState"
    check_wait_retries: 300
    check_wait_delay: 10
    check_reason: "After applying SRIOV config"

...
