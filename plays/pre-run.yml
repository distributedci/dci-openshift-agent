---
# Prepare host
- name: Configure jumpbox
  include_tasks: configure-jumpbox.yml

- name: Reset bmc
  command: "ipmitool -I lanplus -U {{ hostvars[item]['ipmi_user'] }} -P {{ hostvars[item]['ipmi_password'] }} -H {{ hostvars[item]['ipmi_address'] }} -p {{ hostvars[item]['ipmi_port'] | default(623) }} mc reset cold"
  with_items: "{{ groups['masters'] + groups['workers'] }}"
  when:
    - dci_reset_bmc|default(False)|bool

# Download Openshift from DCI
- name: Import Openshift files from DCI
  include_tasks: fetch-bits.yml

- name: Get provisioner SSH identity
  delegate_to: "{{ groups['provisioner'][0] }}"
  fetch:
    src: "~{{ ansible_user }}/.ssh/id_rsa"
    dest: "~/.ssh/{{ cluster }}-provisioner_rsa"
    flat: true

- name: Erase bootloader to prevent old OS to boot
  delegate_to: "{{ item }}"
  become: true
  shell: |
    if grep 'Red Hat Enterprise Linux CoreOS' /etc/os-release; then
      for disk in /dev/sd?; do
        dd if=/dev/zero of=$disk bs=512 count=1
      done
    fi
  when:
    - dci_erase_bootloader_on_disk|default(False)|bool
    - dci_main is not defined or dci_main == 'install'
  with_items: "{{ groups['masters'] + groups['workers'] }}"
  ignore_unreachable: true
  ignore_errors: true

- name: Gather the package facts
  package_facts:
    manager: auto

- include_tasks: track_rpm.yml
  with_items: "{{ dci_rpms_to_components }}"

- include_tasks: track_git_repo.yml
  with_items: "{{ dci_gits_to_components }}"

- name: Check bmc
  command: "ipmitool -I lanplus -U {{ hostvars[item]['ipmi_user'] }} -P {{ hostvars[item]['ipmi_password'] }} -H {{ hostvars[item]['ipmi_address'] }} -p {{ hostvars[item]['ipmi_port'] | default(623) }} mc info"
  with_items: "{{ groups['masters'] + groups['workers'] }}"
  retries: 6
  delay: 10
  register: result
  until: result.rc == 0
  when:
    - dci_reset_bmc|default(False)|bool
...
