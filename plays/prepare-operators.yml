- name: "Get cluster pull-secret for ACM"
  include_tasks: get-cluster-pullsecret.yml
  when:
    - dci_disconnected | default(false) | bool
    - install_type == 'acm'

- name: "Configure auths for docker compatible tools"
  block:
    - name: "Create temp directory for docker auths"
      tempfile:
        state: directory
        prefix: dci_auth.
      register: docker_conf

    - name: "Copy dci_pull_secret as config.json"
      copy:
        src: "{{ dci_pullsecret_file }}"
        dest: "{{ docker_conf.path }}/config.json"
        mode: "0640"
  when:
    - dci_pullsecret_file is defined

- name: "Disable default catalog sources for disconnected deployment"
  block:
    - name: "Disable default catalog sources for disconnected deployment"
      community.kubernetes.k8s:
        definition:
          apiVersion: config.openshift.io/v1
          kind: OperatorHub
          metadata:
            name: cluster
          spec:
            disableAllDefaultSources: true

    - name: "Validate Red Hat catalogSources are disabled"
      community.kubernetes.k8s_info:
        api: operators.coreos.com/v1alpha1
        kind: CatalogSource
        namespace: openshift-marketplace
      register: catalogs_list
      until:
        - catalogs_list.resources is defined
        - catalogs_list.resources | length == 0
      retries: 6
      delay: 10
  when:
    - dci_main == 'install'
    - dci_disconnected | default(false) | bool

- name: "Catalog from Image"
  include_tasks:
    file: catalog-from-image.yml
    apply:
      environment:
        DOCKER_CONFIG: "{{ docker_conf.path }}"
  when:
    - file_catalog | length == 0

- name: "Catalog from File"
  include_tasks:
    file: catalog-from-file.yml
    apply:
      environment:
        DOCKER_CONFIG: "{{ docker_conf.path }}"
  when:
    - file_catalog | length
    - dci_local_registry | length

- name: "Mirror custom catalogs"
  include_tasks: mirror-catalog.yml
  loop: "{{ custom_catalogs }}"
  loop_control:
    loop_var: catalog
  when:
    - custom_catalogs | default([]) | length

- name: "Apply ICSPs for all catalogs"
  block:
    - name: "Apply ICSP manifests"
      community.kubernetes.k8s:
        state: present
        src: "{{ icsp_file }}"
      loop: "{{ icsp_files | unique | select | list }}"
      loop_control:
        loop_var: icsp_file

    - name: "Delete ICSP manifest"
      file:
        path: "{{ icsp_file }}"
        state: absent
      loop: "{{ icsp_files | unique | select | list }}"
      loop_control:
        loop_var: icsp_file
  when:
    - icsp_files is defined
    - icsp_files | length

- name: "Wait for updated MCP after applying ICSP"
  include_role:
    name: check-resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: 30
    check_wait_delay: 10
    check_reason: "Apply ICSPs for mirrored catalogs"

- name: "Clean-up the ICSPs list"
  set_fact:
    icsp_files: []

- name: "Create custom catalog sources"
  include_role:
    name: catalog-source
  vars:
    cs_name: "{{ ((catalog | basename).split(':'))[0] }}"
    cs_namespace: "openshift-marketplace"
    cs_image: "{{ catalog }}"
  loop: "{{ custom_catalogs }}"
  loop_control:
    loop_var: catalog
  when:
    - custom_catalogs | default([]) | length
...
