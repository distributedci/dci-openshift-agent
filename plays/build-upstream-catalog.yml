- name: "Build custom index from upstream for OCP Dev/Candidate versions"
  vars:
    base_version: "{{ version.split('.')[0] }}.{{ version.split('.')[1] }}"
    sriov_catalog: "{{ local_registry_host }}:{{ local_registry_port }}/telcoci/upstream/sriov-operator-catalog:{{ base_version }}"
    sriov_bundle: "{{ local_registry_host }}:{{ local_registry_port }}/telcoci/upstream/sriov-operator-bundle"
  when:
    - enable_sriov | bool
  block:
    # Blocks to build other operators bundles may be required
    - name: "Building SRIOV bundle"
      block:
        - name: Create temporary build directory
          tempfile:
            state: directory
            prefix: bundle_dir.
          register: bundle_tmp_dir

        - name: "Set working directory"
          set_fact:
            bundle_tmp_dir: "{{ bundle_tmp_dir.path }}"

        - name: "Clone/update SRIOV network-operator repo"
          vars:
            git_repo: "https://github.com/openshift/sriov-network-operator.git"
            git_ref: "release-{{ base_version }}"
          git:
            version: "{{ git_ref }}"
            repo: "{{ git_repo }}"
            dest: "{{ bundle_tmp_dir }}/sriov-network-operator"
            force: true
          register: sriov_clone
          retries: 3
          delay: 10
          until: not sriov_clone.failed

        - name: "Pin CSV"
          script:
            cmd: >
              plays/scripts/use-digest
              {{ bundle_tmp_dir }}/sriov-network-operator/manifests/stable/sriov-network-operator.clusterserviceversion.yaml

        - name: "Build SRIOV bundle image"
          shell: >
            podman build .
            -f bundleci.Dockerfile
            -t {{ sriov_bundle }}:{{ base_version }}
          args:
            chdir: "{{ bundle_tmp_dir }}/sriov-network-operator"

        - name: "Push the new bundle image to registry"
          shell:
            cmd: >
              podman push {{ sriov_bundle }}:{{ base_version }}
              --authfile {{ dci_pullsecret_file }}

        - name: "Get bundle image SHA256"
          shell:
            cmd: >
              skopeo inspect
              --authfile {{ dci_pullsecret_file }}
              docker://{{ sriov_bundle }}:{{ base_version }} | jq -r '.Digest'
          register: bundle_sha
          retries: 5
          delay: 5
          until:
            - bundle_sha.stdout | regex_search('^sha')

        - name: "Delete temp directory"
          file:
            state: absent
            path: "{{ bundle_tmp_dir }}"

    - name: "Create FBC catalog"
      include_role:
        name: fbc-catalog
      vars:
        fbc_index_image: "{{ sriov_catalog }}"
        fbc_bundles:
          - "{{ sriov_bundle }}@{{ bundle_sha.stdout }}"
        fbc_opm_args: "--skip-tls-verify=false"

    - name: "Push the catalog image to registry"
      shell:
        cmd: >
          podman push {{ sriov_catalog }}
          --authfile {{ dci_pullsecret_file }}

    - name: "Remove local images"
      shell:
        cmd: >
          podman rmi -f
          {{ sriov_bundle }}:{{ base_version }}
          {{ sriov_catalog }}

    - name: "Set the upstream sriov catalog image and version"
      set_fact:
        upstream_sriov_catalog: "{{ sriov_catalog }}"
        additional_catalogs: "{{ additional_catalogs | default([]) + [sriov_catalog] }}"
