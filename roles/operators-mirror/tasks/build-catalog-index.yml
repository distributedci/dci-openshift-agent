---

- name: "Get DCI topic"
  set_fact:
    dci_topic: "{{ hostvars.localhost.job_info.job.topic.name }}" 

- name: "Get OCP version"
  set_fact:
    ocp_version: "{{ dci_topic.split('-')[1] }}"

- name: "Get major OCP version"
  set_fact:
    ocp_major: "{{ ocp_version.split('.')[0] }}"

- name: "Get minor OCP minor"
  set_fact:
    ocp_minor: "{{ ocp_version.split('.')[1] }}"

- name: "Previous minor version"
  set_fact:
    ocp_previous: "{{ ocp_minor | int -1 }}"

- name: "Create a tmp directory for the prune image"
  tempfile:
    state: directory
  register: tmp_prune

- name: "Prune SQLite based catalog index"
  block:
    - name: "Prune source index but opm_mirror_list"
      shell:
        # opm requires write perms in the working directory
        chdir: "{{ tmp_prune.path }}"
        cmd: >
          set -x;
          REGISTRY_AUTH_FILE={{ dci_pullsecret_file }}
          {{ provision_cache_store }}/{{ version }}/opm index prune
          --from-index registry.redhat.io/redhat/redhat-operator-index:v{{ ocp_major }}.{{ minor }}
          --packages {{ opm_mirror_list | join(",") }}
          --tag {{ local_registry }}{{ opm_local_registry_path }}:v{{ ocp_major }}.{{ minor }}
      register: prune_result
      until: prune_result.rc == 0
      retries: 3
      delay: 10
      notify:
        - "Fix permissions and removing tmp files"
  when:
  - ocp_version_maj|int == 4
  - ocp_version_min|int < 10

# This should be a workaround until the opm prune supports FBC format
# https://github.com/redhat-openshift-ecosystem/community-operators-prod/discussions/512
- name: "Prune File Based Catalog index"
  block:
    - name: "Extract channel and package names from Catalog index"
      shell:
        chdir: "{{ tmp_prune.path }}"
        cmd: >
          set -x;
          mkdir "{{ tmp_prune.path }}/configs";
          REGISTRY_AUTH_FILE={{ dci_pullsecret_file }}
          {{ provision_cache_store }}/{{ version }}/opm render
          registry.redhat.io/redhat/redhat-operator-index:v{{ ocp_major }}.{{ minor }} |
          jq 'select( .package == "{{ item }}" or .name == "{{ item }}")'  >> {{ tmp_prune.path }}/configs/index.json
      register: prune_result
      until: prune_result.rc == 0
      retries: 3
      delay: 10
      with_items: "{{ opm_mirror_list }}"
      when:
        - ocp_version_maj|int == 4
        - ocp_version_min|int >= 10

    - name: "Build the catalog index"
      shell:
        chdir: "{{ tmp_prune.path }}"
        cmd: >
          set -x;
          {{ provision_cache_store }}/{{ version }}/opm alpha generate dockerfile {{ tmp_prune.path }}/configs/;
          podman build -t {{ local_registry }}{{ opm_local_registry_path }}:v{{ ocp_major }}.{{ minor }} -f {{ tmp_prune.path }}/configs.Dockerfile . ;
      notify:
        - "Fix permissions and removing tmp files"
  when:
  - ocp_version_maj|int == 4
  - ocp_version_min|int >=  10

- name: "Push the new index image to the local registry"
  shell:
    cmd: >
      podman push {{ local_registry }}{{ opm_local_registry_path }}:v{{ ocp_major }}.{{ minor }}
      --authfile {{ dci_pullsecret_file }}
...
