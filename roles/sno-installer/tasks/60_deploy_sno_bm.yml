---
- name: "Add Kubeconfig to Ansible User .bashrc"
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: "export KUBECONFIG={{ dir }}/auth/kubeconfig"
  tags: install

- name: "Disable PXE Timeout"
  shell: | 
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} raw 0x00 0x08 0x03 0x08

- name: "Set PXE - UEFI Temporally on next boot"
  shell: | 
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} raw 0x00 0x08 0x05 0xa0 0x04 0x00 0x00 0x00
  when: |
    (bootmode is not defined) or
    ("'legacy' not in bootmode")

- name: "Set PXE - BIOS Temporally on next boot"
  shell: | 
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} raw 0x00 0x08 0x05 0x80 0x04 0x00 0x00 0x00
  when:
    - bootmode is defined
    - bootmode == "legacy"

- name: "Recover power status of baremetal node"
  shell: |
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} power status
  register: node_power

- name: "Start the baremetal node"
  shell: |
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} power on
  when:
    - "'Chassis Power is off' in node_power.stdout"

- name: "Reset the baremetal node"
  shell: |
    ipmitool -I lanplus -H {{ hostvars["master-0"].ipmi_address }} -L ADMINISTRATOR -U {{ hostvars["master-0"].ipmi_user }} -R7 -N 5 -P {{ hostvars["master-0"].ipmi_password }} -p {{ hostvars["master-0"].ipmi_port }} power reset
  when:
    - "'Chassis Power is on' in node_power.stdout"

- name: Show How to monitor for installation status
  debug:
    msg:
      - "Next step will provision SNO Baremetal. It might take a few minutes for the API to respond"
      - "Once the api gets available you can run the following in another shell session"
      - "to monitor the installation progress:  export KUBECONFIG={{ dir }}/auth/kubeconfig"
      - "watch -n5 -d 'oc get nodes ; oc get co ; oc get clusterversion'"
  tags: install
...
