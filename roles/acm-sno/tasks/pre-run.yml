---
- name: "Read KUBECONFIG path from env vars"
  set_fact:
    kubeconfig_path: "{{ lookup('env','KUBECONFIG') }}"
  # when: kubeconfig_path is not defined

- name: "Check if KUBECONFIG exists"
  stat:
    path: "{{ kubeconfig_path }}"
  register: kubeconfig

- name: "Fail if kubeconfig NOT found"
  fail:
    msg: "kubeconfig not found at {{ kubeconfig_path }}"
  when: not kubeconfig.stat.exists

- name: "Check if the ACM CRD is present"
  community.kubernetes.k8s_info:
    kind: CustomResourceDefinition
    name: multiclusterengines.multicluster.openshift.io
  register: acm_crd

- name: "Fail if ACM CRD is not present"
  fail:
    msg: "CRDs are not present"
  when: acm_crd.resources | list | count == 0
...
