---
- name: "Get Kubeconfig secret"
  community.kubernetes.k8s_info:
    api: v1
    kind: Secret
    name: "{{ acm_cluster_name }}-admin-kubeconfig"
    namespace: "{{ acm_cluster_name }}"
  register: kubeconfig_secret
  no_log: true

- name: "Get kubeadmin credentials"
  community.kubernetes.k8s_info:
    api: v1
    kind: Secret
    name: "{{ acm_cluster_name }}-admin-password"
    namespace: "{{ acm_cluster_name }}"
  register: kubeconfig_password

- name: "Set credentials facts"
  set_fact:
    acm_kubeconfig_text: '{{ kubeconfig_secret.resources[0].data["kubeconfig"] | b64decode }}'
    acm_kubeconfig_user: '{{ kubeconfig_password.resources[0].data["username"] }}'
    acm_kubeconfig_pass: '{{ kubeconfig_password.resources[0].data["password"] }}'
  no_log: true

- name: "Create a temp directory"
  tempfile:
    state: directory
  register: acm_dir

- name: "Set working directory path"
  set_fact:
    acm_dir: "{{ acm_dir.path }}"

- name: "Save the kubeconfig to a file"
  copy:
    content: "{{ acm_kubeconfig_text }}"
    dest: "{{ acm_dir }}/kubeconfig"
    mode: 0600

- name: "Saving credentials to a file"
  copy:
    content: "Cluster credentials\n
              ---\n
              username: {{ acm_kubeconfig_user }}\n
              password: {{ acm_kubeconfig_pass }}\n"
    dest: "{{ acm_dir }}/ocp_creds.txt"
    mode: 0600

- name: "Print credentials details"
  debug:
    msg:
      - "Cluster credentials have been saved in {{ acm_dir }}/ocp_creds.txt"
...
