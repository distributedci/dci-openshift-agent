---
- name: Test CephRBD PVC
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: rbd-pvc
        namespace: default
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        storageClassName: "{{ ocs_sc_rbd_name }}"
  register: ocs_cephrbd_pvc

- name: Test CephFS PVC
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: cephfs-pvc
        namespace: default
      spec:
        accessModes:
        - ReadWriteMany
        resources:
          requests:
            storage: 1Gi
        storageClassName: "{{ ocs_sc_cephfs_name }}"
  register: ocs_cephfs_pvc

- name: Wait 60 seconds for PVCs to bound
  wait_for:
    timeout: 60
  when: (ocs_cephrbd_pvc.changed | bool) or (ocs_cephfs_pvc.changed | bool)

- name: Get CephRBD PVC status
  community.kubernetes.k8s_info:
    kind: PersistentVolumeClaim
    namespace: default
    name: rbd-pvc
  register: cephrbd_pvc_status
  when:
    - ocs_storageclass_rbd.resources is defined
    - ocs_storageclass_rbd.resources != []
    - ocs_sc_rbd_name == ocs_storageclass_rbd.resources[0].metadata.name

- name: CephRBD PVC Status is Bound
  debug:
    var: cephrbd_pvc_status.resources[0].status.phase
  when:
    - "'resources' in cephrbd_pvc_status"
    - cephrbd_pvc_status.resources != []
  failed_when:
    - cephrbd_pvc_status.resources[0].status.phase != "Bound"

- name: Get CephFS PVC status
  community.kubernetes.k8s_info:
    kind: PersistentVolumeClaim
    namespace: default
    name: cephfs-pvc
  register: cephfs_pvc_status
  when:
    - ocs_storageclass_cephfs.resources is defined
    - ocs_storageclass_cephfs.resources != []
    - ocs_sc_cephfs_name == ocs_storageclass_cephfs.resources[0].metadata.name

- name: CephFS PVC status is Bound
  debug:
    var: cephfs_pvc_status.resources[0].status.phase
  when:
    - "'resources' in cephfs_pvc_status"
    - cephfs_pvc_status.resources != []
  failed_when:
    - cephfs_pvc_status.resources[0].status.phase != "Bound"
...
