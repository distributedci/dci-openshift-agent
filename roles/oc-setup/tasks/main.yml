---
- name: "oc-setup : Set facts"
  include_tasks: facts.yml
  when:
    - dci_cluster_configs_dir is undefined
  tags:
    - facts

- name: "oc-setup : Install binaries and other packages in jumphost"
  include_tasks: install.yml
  tags:
    - install

- name: "oc-setup : Check the master nodes managed by MCP are updated and ready"
  k8s_info:
    kind: MachineConfigPool
    name: master
  register: mcp_master
  retries: 240
  delay: 10
  until:
    - "'resources' in mcp_master"
    - "mcp_master.resources|length == 1"
    - "'status' in mcp_master.resources[0]"
    - "mcp_master.resources[0].status.readyMachineCount == mcp_master.resources[0].status.machineCount"
    - "mcp_master.resources[0].status.updatedMachineCount == mcp_master.resources[0].status.machineCount"

- name: "oc-setup : Check the worker nodes managed by MCP are updated and ready"
  k8s_info:
    kind: MachineConfigPool
    name: worker
  register: mcp_worker
  retries: 300
  delay: 10
  until:
    - "'resources' in mcp_worker"
    - "mcp_worker.resources|length == 1"
    - "'status' in mcp_worker.resources[0]"
    - "mcp_worker.resources[0].status.readyMachineCount == mcp_worker.resources[0].status.machineCount"
    - "mcp_worker.resources[0].status.updatedMachineCount == mcp_worker.resources[0].status.machineCount"

- name: "oc-setup : Check inventory to match ocp cluster config"
  environment:
    KUBECONFIG: "{{ dci_cluster_configs_dir }}/kubeconfig"
  k8s_info:
    api_version: v1
    kind: node
    name: "{{ hostvars[item].name }}"
  register: node
  with_items: "{{ groups['masters'] + groups['workers'] }}"
  failed_when: "'resources' not in node or node.resources == []"
  tags:
    - check

- name: "oc-setup : Configure clients in jumphost"
  include_tasks: config.yml
  tags:
    - config
...
