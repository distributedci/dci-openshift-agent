---
- name: "Mirror release images to local registry"
  command: >
    {{ dir }}/oc adm release mirror
    --registry-config={{ auths_file }}
    --from={{ ocp_release_data['container_image'] | quote }}
    --to-release-image={{ registry_url | urlsplit('netloc') }}{{ registry_url | urlsplit('path') }}:{{ version }}
    --to={{ registry_url | urlsplit('netloc') | quote }}{{ registry_url | urlsplit('path') | quote }}
  retries: 3
  delay: 10
  register: result
  until: result.rc == 0

- name: Generate ImageContentSourcePolicy
  command: >
    echo -e {{ result.stdout }} |
    sed -n '/apiVersion/,source/p'
  register: icsp_release

- name: "Write mirrored image content source policy"
  copy:
    dest: "{{ dir }}/imagecontentsourcepolicy.yaml"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
    setype: httpd_sys_content_t
    content: "{{ icsp_release.stdout }}"
  become: true

...
