---
- name: "Read release_image from release.txt"
  shell:
    cmd: >
      sed -n 's/Pull From:\s*\(.*\)/\1/p'
      {{ dir }}/release.txt | tr -d '[[:blank:]]'
    warn: false  # runner complains about using sed
  register: release_image
  changed_when: false

- debug:
    var: release_image.stdout

- name: "Check if registry has already been mirrored"
  stat:
    path: "{{ dir }}/container_images.done"
    get_checksum: false
  register: container_images_done
  when:
    - not force  # we don't care to stat files if we're forcing

- name: "Mirror release images to local registry"
  command: >
    {{ dir }}/oc adm release mirror
    --registry-config={{ dci_pullsecret_file }}
    --from={{ release_image.stdout | quote }}
    --to-release-image={{ registry_url | urlsplit('netloc') }}{{ registry_url | urlsplit('path') }}:{{ version }}
    --to={{ registry_url | urlsplit('netloc') | quote }}{{ registry_url | urlsplit('path') | quote }}
  retries: 3
  delay: 10
  register: result
  until: result.rc == 0
  when:
    - force or not container_images_done.stat.exists

- name: "Marker for container images mirrored"
  file:
    dest: "{{ cache_dir }}/{{ version }}/container_images.done"
    state: touch
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: "0644"
  become: true
  when:
    - force or not container_images_done.stat.exists
...
