---
- name: "Read release_image from release.txt"
  shell:
    cmd: >
      sed -n 's/Pull From:\s*\(.*\)/\1/p'
      {{ mor_cache_dir }}/{{ mor_version }}/release.txt | tr -d '[[:blank:]]'
  register: release_image
  changed_when: false

- name: "Check if installer has been extracted"
  stat:
    path: "{{ mor_cache_dir }}/{{ mor_version }}/{{ mor_installer }}"
    get_checksum: false
  register: target
  when:
    - not mor_force  # we don't care to stat files if we're forcing

- name: "Extract installer command from container image"
  command: >
    {{ mor_cache_dir }}/{{ mor_version }}/oc adm release extract
    --registry-config={{ mor_auths_file }}
    --command={{ mor_installer }}
    --to={{ mor_cache_dir }}/{{ mor_version }}
    {{ release_image.stdout }}
  when:
    - mor_force or not target.stat.exists

- name: "Make installer command readable from HTTP"
  file:
    path: "{{ mor_cache_dir }}/{{ mor_version }}/{{ mor_installer }}"
    state: file
    owner: "{{ mor_owner }}"
    group: "{{ mor_group }}"
    mode: "0755"
    setype: "httpd_sys_content_t"
...
