---
- block:
    - include_tasks: setup.yml
    - include_tasks: ssh_keygen.yml
    - include_tasks: libvirt_network_up.yml
      loop: "{{ networks }}"
      loop_control:
        loop_var: network
    - include_tasks: libvirt_host_up.yml
      loop: "{{ hosts }}"
      loop_control:
        loop_var: host
    - include_tasks: libvirt_host_up2.yml
      loop: "{{ hosts }}"
      loop_control:
        loop_var: host
    - include_tasks: dns_setup.yml
      when: do_dns_config|bool
    - include_role:
        name: vbmc
      vars:
        vbmc_host: "{{ vbmc_host_provided }}"
        vbmc_nodes: "{{ resources }}"
    - include_tasks: dci_setup.yml
    - include_role:
        name: conserver
      vars:
        cluster_nodes: "{{ groups['masters'] + ('workers' in groups) | ternary(groups['workers'], []) }}"
      when: enable_conserver

    - block:
        - name: "Get Ansible roles path"
          shell: "set -o pipefail && ansible-config dump|grep DEFAULT_ROLES_PATH|sed -e 's/.*=\\s*//'"
          register: roles_path_cmd

        - name: "Set roles_path"
          set_fact:
            roles_path: "{{ roles_path_cmd.stdout }}"

        - name: Set dci_cache_dir variable
          set_fact:
            dci_cache_dir: "{{ item | regexp_replace('^(.*)assisted_deploy_repo.*$', '\\1') }}"
          loop: roles_path
          when: "'assisted_deploy_repo' in item"

        - name: "Clone/update assisted-deploy repo"
          vars:
            git_repo: "{{ assisted_deploy_repo }}"
            git_ref: "{{ assisted_deploy_version }}"
          git:
            version: "{{ git_ref }}"
            repo: "{{ git_repo }}"
            dest: "{{ dci_cache_dir }}/assisted_deploy_repo"
            force: true
          # On RHEL8 git clone can sporadically fail with OpenSSL SSL_read:
          # SSL_ERROR_SYSCALL, errno 104.
          register: git_clone
          retries: 3
          delay: 10
          until: not git_clone.failed
          when:
            - "dci_cache_dir + '/assisted_deploy_repo/roles' in roles_path"
          tags:
            - clone_upstream_repos

        - name: Install sushy-tools
          include_role:
            name: setup_sushy_tools
      when: enable_redfish
  when: hook_action == 'install'

- block:
    - include_tasks: libvirt_host_destroy.yml
      loop: "{{ hosts }}"
      loop_control:
        loop_var: host
    - include_tasks: libvirt_network_destroy.yml
      loop: "{{ networks }}"
      loop_control:
        loop_var: network
    - include_tasks: dns_cleanup.yml
      when: do_dns_config|bool
    - include_role:
        name: vbmc
      vars:
        vbmc_host: "{{ vbmc_host_provided }}"
        vbmc_nodes: "{{ resources }}"
  when: hook_action == 'cleanup'
