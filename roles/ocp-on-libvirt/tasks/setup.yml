---
- name: "reset ssh connection to allow user changes to affect {{ ansible_user_id }}"
  meta: reset_connection

- name: Enable EPEL
  become: true
  package:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  when: ansible_distribution_major_version == '7'

- name: Install packages required for libvirt
  become: true
  package:
    name:
      - libvirt-daemon-kvm
      - git
      - genisoimage
      - libvirt
      - libvirt-daemon-kvm
      - virt-install
      - "libvirt-python{% if ansible_python.version.major == 3 %}3{% endif %}"
      - "python{% if ansible_python.version.major == 3 %}3{% endif %}-netaddr"
      - "python{% if ansible_python.version.major == 3 %}3{% endif %}-lxml"
      - "python{{ ansible_python.version.major }}-pip"
      - "python{% if ansible_python.version.major == 3 %}3{% endif %}-virtualenv"

      #- name: Copy the SELinux for OCP on Libvirt module description
      #copy:
        #dest: /tmp/libvirt.te
        #content: |
          #module libvirt 1.0;
          #
          #require {
          #type tmp_t;
          #type svirt_t;
          #class sock_file unlink;
          #}
          #
          ##============= svirt_t ==============
          #allow svirt_t tmp_t:sock_file unlink;
          #tags: selinux

          #- name: Install the libvirt selinux module
          #shell: |
            #checkmodule -M -m -o libvirt.mod libvirt.te
            #semodule_package -o libvirt.pp -m libvirt.mod
            #semodule -i libvirt.pp
            #args:
              #chdir: /tmp/
              #become: yes
              #tags: selinux


- name: Get processor family
  set_fact:
    proc_family: >-
      {{ ('AMD' in (ansible_processor | join()))|
      ternary ('amd','intel') }}

- name: Check on nested KVM status
  command: |
    cat /sys/module/kvm_{{ proc_family }}/parameters/nested
  ignore_errors: true
  register: nested_kvm

- name: Enable nested Virt
  become: true
  copy:
    content: |
      options kvm-{{ proc_family }} nested=1
      options kvm-{{ proc_family }} enable_shadow_vmcs=1
      options kvm-{{ proc_family }} enable_apicv=1
      options kvm-{{ proc_family }} ept=1
    dest: /etc/modprobe.d/kvm_nested.conf
  when: nested_kvm.stdout != 'Y'

- name: Reload KVM module
  become: true
  shell: |
    modprobe -r kvm_{{ proc_family }}
    modprobe -a kvm_{{ proc_family }}
  when: nested_kvm.stdout != 'Y'

- name: Enable and Start libvirtd
  become: true
  service:
    name: libvirtd
    enabled: yes
    state: started

- name: Create the consoles directory
  become: true
  file:
    path: /var/lib/libvirt/consoles
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Set SELinux context under the consoles directory
  sefcontext:
    target: '/var/lib/libvirt/consoles(/.*)?'
    setype: svirt_home_t
  become: yes

- name: Restore the contexts under the consoles directory
  shell: /usr/sbin/restorecon -irv /var/lib/libvirt/consoles

- name: "Add {{ ansible_user_id }} user to libvirt and qemu groups"
  become: true
  user:
    name: "{{ ansible_user_id }}"
    append: yes
    groups:
      - libvirt
      - qemu
