---
- name: Set Defaults
  set_fact:
    ipmi_sol_hosts: []
    socket_hosts: []

- name: Check for Serial over IPMI
  command:
    cmd: >
      ipmitool -H {{ hostvars[item].ipmi_address }}
               -U {{ hostvars[item].ipmi_user }}
               -P {{ hostvars[item].ipmi_password }}
               -p {{ hostvars[item].ipmi_port }}
               -I lanplus
               sol info
  register: ipmi_sol
  ignore_errors: true
  with_items: "{{ groups['masters'] + ('workers' in groups) | ternary(groups['workers'], []) }}"

- name: Build list of Serial over IPMI hosts
  set_fact:
    ipmi_sol_hosts: "{{ ipmi_sol_hosts + [item.item] }}"
  when: item.rc == 0
  loop: "{{ ipmi_sol.results }}"

- name: Include IPMI console config
  include_tasks: config-ipmi.yml
  when: ipmi_sol_hosts| length>0

- name: Build list of Serial over SOCKET hosts (libvirt)
  set_fact:
    socket_hosts: "{{ socket_hosts + [item] }}"
  when:
    - hostvars[item].socket_console| default(false)
  with_items: "{{ groups['masters'] + ('workers' in groups) | ternary(groups['workers'], []) }}"

- name: Include libvirt console config
  include_tasks: config-libvirt.yml
  when: socket_hosts| length>0
