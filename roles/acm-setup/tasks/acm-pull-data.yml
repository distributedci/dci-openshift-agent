---
- name: "Get current worker's MCP"
  community.kubernetes.k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
    name: worker
  register: worker_mcp

- name: "Get current worker's Machine config Pools"
  set_fact:
    acm_mc: "{{ worker_mcp.resources[0].spec.configuration.name }}"

- name: "Get current worker's Machine configs"
  community.kubernetes.k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    name: "{{ acm_mc }}"
  register: worker_mc

- name: "Setting config facts based on Hub Cluster configs"
  vars:
    query: "resources[0].spec.config.storage.files[? path=='/etc/containers/registries.conf']"
  set_fact:
    acm_ssh_key: "{{ worker_mc.resources[0].spec.config.passwd.users[0].sshAuthorizedKeys[0] }}"
    registry_details: "{{ worker_mc | json_query(query) }}"

- name: "Setting config facts based on Hub Cluster"
  set_fact:
    acm_registry_conf: "{{ user_registry | default(registry_details[0].contents.source.split(',')[1] | urldecode() ) }}"
 
- name: "Get cluster user-ca cert if exists"
  community.kubernetes.k8s_info:
    api: v1
    kind: ConfigMap
    name: "user-ca-bundle"
    namespace: openshift-config
  register: user_ca_bundle

- name: "Get the user_ca_bundle content"
  set_fact:
    acm_user_ca_bundle: '{{ user_bundle | default(user_ca_bundle.resources[0].data["ca-bundle.crt"]) }}'
  when:
    - user_bundle is defined or
      user_ca_bundle.resources | length == 1

- name: "Create Config map with mirroring details and CA bundle"
  community.kubernetes.k8s:
    state: present
    template: mirror-registry-cm.j2
...
