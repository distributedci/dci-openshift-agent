---
- name: Create hosts inventory file
  hosts: localhost
  tasks:
    - name: Figure out the jumpbox's main DNS
      when: provisioner_dns is not defined
      block:
        - name: Query nmcli for DNS server
          shell:
            cmd: "/usr/bin/nmcli device show | grep IP4.DNS | tr -s ' ' | cut -d' ' -f 2 | head -1"
          register: nmcli_cmd

        - name: Set fact
          set_fact:
            provisioner_dns: "{{ nmcli_cmd.stdout }}"

    - name: Generating hosts inventory file
      template:
        src: ./templates/hosts.j2
        dest: "{{ inventory_prefix }}hosts"
      vars:
        input_prefix: "{{ lookup('env', 'PREFIX') }}"
        inventory_prefix: "{{ (input_prefix | replace('-p ', '')) + '-' if input_prefix != '' else '' }}"
...
