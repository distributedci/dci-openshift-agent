---

- name: check
  hosts: localhost
  tasks:
    - name: Ensure .config/openstack directory exist
      file:
        path: '{{ config_cloud_path }}'
        state: directory
      tags:
        - config

    - name: Configure cloud provider config
      blockinfile:
        content: |
          clouds:
          {{'  '}}{{ config_cloud_name }}:
              auth:
                username: {{ config_cloud_user }}
                password: {{ config_cloud_pass }}
                project_name: {{ config_cloud_project }}
                auth_url: {{ config_cloud_auth }}
              region_name: {{ config_cloud_region }}
        path: '{{ config_cloud_path }}/clouds.yaml'
        create: true
      tags:
        - config

    - name: Create vms
      os_server:
        cloud: '{{ config_cloud_name }}'
        state: present
        name: '{{ item.name }}'
        image: RHEL 7.6 x86_64
        timeout: 200
        flavor: "{{ item.flavor }}"
        volume_size: 50
        userdata: |
          #cloud-config
          users:
            - default
            - name: cloud-user
              ssh_authorized_keys:
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDKxwVW3koSJlJGaC/fMjom+PmU42BZr6DVoCQXpXQcWlu5gdMe4cxOrlBxb738SiDFE+7W3TfXuKtW3nPaobYPej0zdSVXJzQviDUXoO2cNCH5wVQrsb9NraRJkgEIE8dqXVb3deriM3TWml9GjK3rC3QhutSZgPpvXca9T36co6Nn69Bn2nPLoiH+BLdG+44ZPPSjE5O38Qzsc2KteRM/6DWn3+1YAYx6i855WsG8ZZnVk6eiRTyZpFvsVenpBCj5ec3UvDswVtikm65Wq9Bg9A6ZoJ6MbGcBbe6cMP+Qs4p0flqJIjNULhvZmu4XoTmFMTWagousJm5tffA/E3jf thomas@ThinkPad
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHwr4zWwmiP2ObS5PrZFrGAQBFcHazUop4zk1H5pUves8LCq/P0fwOodh6EOD1R6B3VJftrjmJDPiZrewcbTKcXoaQvuZNThimg0rNadQkVOfwy/58ush7NUgQIA2ck4zHuqf0wuJ4rumRASxACYKeNOm8zeJDXkAOsY7OK1Fhma4ALTOcZi6pb+L7AoP2BVcfdpBBnYYe4HAv/PZjP/WBgv6BxRNNVSRhJ1TuqrNcYjwmIlRImjEgdKyO5+JJ4CvZy5hQdeUEmiUxk1+z6aPSvtl5gm3ZmsOlrT5TVSENNknUNHF4zoc91o/n3u8b5cIJzjmLel0IT0caihnFCEcn ds@skull-island
        security_groups: ['default']
        network: private
        auto_ip: no
        terminate_volume: true
        boot_from_volume: true
      with_items: '{{ instances }}'
      register: vms

    - name: Add vms to ansible inventory
      add_host:
        name: '{{ item.item.name }}'
        group: 'openshift'
        ansible_host: '{{ item.openstack.private_v4 }}'
        ansible_user: 'cloud-user'
      with_items: '{{ vms.results }}'
      register: vms

    - name: Unregister the node
      redhat_subscription:
        state: absent
      become: true

- hosts: localhost
  tasks:
    - name: Ensure the vms are absent
      os_server:
        cloud: '{{ config_cloud_name }}'
        name: '{{ item.name }}'
        state: absent
      with_items: '{{ instances }}'
      tags:
        - clean