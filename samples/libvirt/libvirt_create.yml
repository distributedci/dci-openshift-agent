- name: Configure libvirt env with linchpin
  hosts: localhost
  any_errors_fatal: true
  tasks:
    - name: Enable EPEL
      become: true
      package:
        name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

    - name: Install packages required for libvirt and linchpin
      become: true
      package:
        name:
          - python-netaddr
          - libvirt-python
          - libvirt-daemon-kvm
          - python-lxml
          - python-pip
          - python-virtualenv
          - git
          - genisoimage
          - libvirt
          - libvirt-daemon-kvm
          - virt-install

    - name: Check on nested KVM status
      command: |
        cat /sys/module/kvm_intel/parameters/nested
      ignore_errors: true
      register: nested_kvm

    - name: Enable nested Virt
      become: true
      copy:
        content: |
          options kvm-intel nested=1
          options kvm-intel enable_shadow_vmcs=1
          options kvm-intel enable_apicv=1
          options kvm-intel ept=1
        dest: /etc/modprobe.d/kvm_nested.conf
      when: nested_kvm.stdout != 'Y'

    - name: Reload KVM module
      become: true
      shell: |
        modprobe -r kvm_intel
        modprobe -a kvm_intel
      when: nested_kvm.stdout != 'Y'

    - name: Add dci-openshift-agent user to libvirt and qemu groups
      become: true
      user:
        name: dci-openshift-agent
        append: yes
        groups:
          - libvirt
          - qemu

    - name: reset ssh connection to allow user changes to affect 'current login user'
      meta: reset_connection

    - name: Enable and Start libvirtd
      become: true
      service:
        name: libvirtd
        enabled: yes
        state: started

    - name: Install linchpin in venv
      pip:
        virtualenv: "/var/lib/dci-openshift-agent/linchpin"
        virtualenv_site_packages: yes
        name:
          - linchpin[libvirt]

    - name: Launch LinchPin to create nodes
      command: |
        /var/lib/dci-openshift-agent/linchpin/bin/linchpin --template-data @libvirt_settings.yml -v up libvirt-network libvirt-hosts
