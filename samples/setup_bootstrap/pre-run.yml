---
- name: Get list of VM's
  virt:
    command: list_vms
  register: all_vms

- name: Shutdown masters and workers
  virt:
    name: "{{ item }}"
    state: destroyed
  with_items: "{{ all_vms.list_vms | select('match', '^(master|worker)-[0-9]+') | list }}"

- name: Revert provisionhost to before OCP install
  become: true
  command: |
    virsh snapshot-revert {{ item }} \
                          {{ item }}-before-oc-install
  with_items: "{{ groups['provisioner'] }}"

- name: Startup provisionhost
  virt:
    name: "{{ item }}"
    state: running
  with_items: "{{ groups['provisioner'] }}"

- name: Wait for hosts to be online
  wait_for:
    host: '{{ item }}'
    port: 22
    search_regex: OpenSSH
    delay: 15
  with_items: "{{ groups['provisioner'] }}"

- name: Manually edit metal3-config template
  lineinfile:
    line: '  provisioning_interface: {{ cluster_pro_if }}'
    path: "{{ dci_cache_dir }}/baremetal_deploy_repo/ansible-ipi-install/roles/installer/templates/metal3-config.j2"
    regexp: '  provisioning_interface: '
