---
- name: "reset ssh connection to allow user changes to affect {{ ansible_user_id }}"
  meta: reset_connection

- name: Enable EPEL
  become: true
  package:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  when: ansible_distribution_major_version == '7'

- name: Install packages required for libvirt
  become: true
  package:
    name:
      - libvirt-daemon-kvm
      - git
      - genisoimage
      - libvirt
      - libvirt-daemon-kvm
      - virt-install

- name: Install python2.7 packages required for libvirt and linchpin
  become: true
  package:
    name:
      - libvirt-python
      - python-netaddr
      - python-lxml
      - python2-pip
      - python-virtualenv
  when: ansible_python_version.startswith('2.7')

- name: Install python3 packages required for libvirt and linchpin
  become: true
  package:
    name:
      - libvirt-python3
      - python3-netaddr
      - python3-lxml
      - python3-pip
      - python3-virtualenv
  when: ansible_python_version.startswith('3')

- name: Check on nested KVM status
  command: |
    cat /sys/module/kvm_intel/parameters/nested
  ignore_errors: true
  register: nested_kvm

- name: Enable nested Virt
  become: true
  copy:
    content: |
      options kvm-intel nested=1
      options kvm-intel enable_shadow_vmcs=1
      options kvm-intel enable_apicv=1
      options kvm-intel ept=1
    dest: /etc/modprobe.d/kvm_nested.conf
  when: nested_kvm.stdout != 'Y'

- name: Reload KVM module
  become: true
  shell: |
    modprobe -r kvm_intel
    modprobe -a kvm_intel
  when: nested_kvm.stdout != 'Y'

- name: Enable and Start libvirtd
  become: true
  service:
    name: libvirtd
    enabled: yes
    state: started

- name: "Add {{ ansible_user_id }} user to libvirt and qemu groups"
  become: true
  user:
    name: "{{ ansible_user_id }}"
    append: yes
    groups:
      - libvirt
      - qemu
