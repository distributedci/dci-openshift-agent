---
#
# This is a sample hook to create 4 VMs on OpenStack.
# 1 controller
# 1 master
# 2 worker

- hosts: localhost
  tasks:
    - name: Ensure .config/openstack directory exist
      file:
        path: '{{ config_cloud_path }}'
        state: directory
      tags:
        - config

    - name: Configure cloud provider config
      blockinfile:
        content: |
          clouds:
          {{'  '}}{{ config_cloud_name }}:
              auth:
                username: {{ config_cloud_user }}
                password: {{ config_cloud_pass }}
                project_name: {{ config_cloud_project }}
                auth_url: {{ config_cloud_auth }}
              region_name: {{ config_cloud_region }}
        path: '{{ config_cloud_path }}/clouds.yaml'
        create: true
      tags:
        - config

    - name: Ensure the vms are absent
      os_server:
        cloud: '{{ config_cloud_name }}'
        name: '{{ item.name }}'
        state: absent
      with_items: '{{ instances }}'
      tags:
        - clean

    - name: Create vms
      os_server:
        cloud: '{{ config_cloud_name }}'
        state: present
        name: '{{ item.name }}'
        image: RHEL 7.6 x86_64
        timeout: 200
        flavor: "{{ item.flavor }}"
        volume_size: 50
        userdata: |
          #cloud-config
          users:
            - default
            - name: cloud-user
              ssh_authorized_keys:
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDKxwVW3koSJlJGaC/fMjom+PmU42BZr6DVoCQXpXQcWlu5gdMe4cxOrlBxb738SiDFE+7W3TfXuKtW3nPaobYPej0zdSVXJzQviDUXoO2cNCH5wVQrsb9NraRJkgEIE8dqXVb3deriM3TWml9GjK3rC3QhutSZgPpvXca9T36co6Nn69Bn2nPLoiH+BLdG+44ZPPSjE5O38Qzsc2KteRM/6DWn3+1YAYx6i855WsG8ZZnVk6eiRTyZpFvsVenpBCj5ec3UvDswVtikm65Wq9Bg9A6ZoJ6MbGcBbe6cMP+Qs4p0flqJIjNULhvZmu4XoTmFMTWagousJm5tffA/E3jf thomas@ThinkPad
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHwr4zWwmiP2ObS5PrZFrGAQBFcHazUop4zk1H5pUves8LCq/P0fwOodh6EOD1R6B3VJftrjmJDPiZrewcbTKcXoaQvuZNThimg0rNadQkVOfwy/58ush7NUgQIA2ck4zHuqf0wuJ4rumRASxACYKeNOm8zeJDXkAOsY7OK1Fhma4ALTOcZi6pb+L7AoP2BVcfdpBBnYYe4HAv/PZjP/WBgv6BxRNNVSRhJ1TuqrNcYjwmIlRImjEgdKyO5+JJ4CvZy5hQdeUEmiUxk1+z6aPSvtl5gm3ZmsOlrT5TVSENNknUNHF4zoc91o/n3u8b5cIJzjmLel0IT0caihnFCEcn ds@skull-island
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjtWnVbjUrF4DczkxUxFne0LRHibK+2RDIRHHelX4wb14wPns1DIe2kMnOKG/smitDfA/QAdEg/5BMPyfgw+HN+YH6KFCsT64b5h8BT3BW7LJcGopRfxDeeq440J/VxT7czfcNcWbplyPvT7IVtaOYFh6M5IaluK6POLGhesWJ+vXsbMKE739e3XaU6fPe+gNjYe/Vbu+luRkkK9pkYdVT7bcnHEEJAI1hE6RlLsO8Q6dIYZs7rYa0FNblOJtner646F/sQGv93GP7UouNPqFRDZRWKTRPF0S01YvaIvb05RfwMCKe7FDJlvjNfYuNRkBTxsFQaSY0Mh8Pc+0W/PPh cloud-user@jumpbox.novalocal
        security_groups: ['default']
        network: private
        auto_ip: no
        terminate_volume: true
        boot_from_volume: true
      with_items: '{{ instances }}'
      register: vms

    - name: Add vms to ansible inventory
      add_host:
        name: '{{ item.item.name }}'
        group: 'openshift'
        ansible_host: '{{ item.openstack.private_v4 }}'
        ansible_user: 'cloud-user'
      with_items: '{{ vms.results }}'

    - name: Wait for hosts to be online
      wait_for:
        host: '{{ item.openstack.private_v4 }}'
        port: 22
        search_regex: OpenSSH
        delay: 15
      with_items: '{{ vms.results }}'

# Configure clusters using group "openshift"

- hosts: openshift
  tasks:
    - name: Generate /etc/hosts
      lineinfile:
        dest: /etc/hosts
        line: '{{ item.openstack.private_v4 }} {{ item.item.name }}.{{ domain }} {{ item.item.name }}'
      become: true
      with_items: "{{ hostvars.localhost.vms.results }}"

    - name: Register the node
      redhat_subscription:
        state: present
        username: dci-ocp-test
        password: dci-ocp-test
        autosubscribe: true
        server_hostname: 'subscription.rhsm.stage.redhat.com:443/subscription'
        rhsm_baseurl: https://cdn.redhat.com 
      become: true

    - name: Disable all repositories
      rhsm_repository:
        name: '*'
        state: disabled
      become: true

    - name: Enable RHEL repositories
      rhsm_repository:
        name:
          - rhel-7-server-rpms
          - rhel-7-server-extras-rpms
          - rhel-7-server-ansible-2.5-rpms
          - rhel-7-server-openstack-13-tools-rpms
        state: enabled
      become: true

    - name: Ensure packages are updated
      yum:
        name: '*'
        state: latest
      become: true

    # - name: Enable DCI Openshift repository
    #   get_url:
    #     # Need to be review
    #     url: http://192.168.0.10/dci_repo/dci_repo.repo
    #     dest: /etc/yum.repos.d/dci_repo.repo
    #   become: true

    - name: Reboot the node
      shell: |
        sleep 3
        reboot
      become: true
      async: 1
      poll: 0

    - name: Wait for the nodes to be back online
      wait_for:
        host: '{{ ansible_host }}'
        port: 22
        search_regex: OpenSSH
        delay: 15
      delegate_to: localhost
