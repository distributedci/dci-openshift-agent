- name: Setting up the jumpbox
  hosts: jumpbox
  become: true
  vars_prompt:
    - name: rhn_user
      private: no
    - name: rhn_pass
      private: yes
  tasks:
    - name: Asserting target OS and version
      assert:
        that:
          - ansible_distribution == 'RedHat'
          - ansible_distribution_major_version == '8'

    - name: Verifying the status of subscription manager
      command: /usr/bin/subscription-manager status
      check_mode: no
      register: subscription_manager_status
      failed_when: no

    - name: Subscribe system to RHN
      redhat_subscription:
        state: present
        username: '{{ rhn_user }}'
        password: '{{ rhn_pass }}'
#        pool_ids:
#          - 2c9280817af91203017b360dc8a644ee: 2
        syspurpose:
          usage: 'Development/Test'
          role: Red Hat Enterprise Linux Server
          service_level_agreement: 'Self-Support'
      when: '"Overall Status: Unknown" in subscription_manager_status.stdout'
      
    - name: Enabling repositories
      rhsm_repository:
        name: '{{ item }}'
        state: enabled
      with_items:
        - rhel-8-for-x86_64-appstream-rpms
        - rhel-8-for-x86_64-baseos-rpms

    - name: Install EPEL release
      yum:
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Install DCI release
      yum:
        name: "https://packages.distributed-ci.io/dci-release.el{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Install dci-openshift-agent
      yum:
        name: dci-openshift-agent
        state: present

    - name: Create the dcirc file
      copy:
        dest: /etc/dci-openshift-agent/dcirc.sh
        content: |
          export DCI_CLIENT_ID='{{ dci_client_id }}'
          export DCI_API_SECRET='{{ dci_api_secret }}'
          export DCI_CS_URL='{{ dci_cs_url }}'
          export ANSIBLE_LOG_PATH='/tmp/dci-openshift-agent.log'

#    - name: Install dnsmasq
#      yum:
#        name: dnsmasq
#        state: latest
#
#    - name: Allowing DNS service in firewall
#      firewalld:
#        zone: public
#        service: dns
#        state: present
#        permanent: yes
#        immediate: yes

          #- name: Set up DHCP dedicated IP (this step is not clear but was don on eno1:2 on jumpbox)
    
    - name: Create the SSH config directory
      file:
        path: /var/lib/dci-openshift-agent/.ssh
        state: directory
        mode: 0700
        owner: dci-openshift-agent
        group: dci-openshift-agent

    - name: Create the SSH key pair
      openssh_keypair:
        comment: dci@cluster
        group: dci-openshift-agent
        owner: dci-openshift-agent
        mode: 0700
        path: /var/lib/dci-openshift-agent/.ssh/id_rsa
        size: 4096
        
    - name: Fetch the SSH public key
      fetch:
        dest: /tmp
        src: /var/lib/dci-openshift-agent/.ssh/id_rsa.pub

    - name: Installing the dnf-automatic package
      yum:
        name: dnf-automatic

    - name: Setting up the dnf-automatic service
      copy:
        dest: /etc/dnf/automatic.conf
        content: |
          [commands]
          upgrade_type = default
          random_sleep = 0
          download_updates = yes
          apply_updates = yes

          [emitters]
          emit_via = stdio
          
          [email]
          email_from = root@example.com
          email_to = root
          email_host = localhost
          
          [command]
          [command_email]
          email_from = root@example.com
          email_to = root
          
          [base]
          debuglevel = 1

    - name: Enabling the dnf-automatic service
      service:
        name: dnf-automatic.timer
        state: started
        enabled: yes
